{% extends 'base.html' %}

{% block title %}{{ movie.title }} - ä¸ªäººå½±è§†ç½‘ç«™{% endblock %}

{% block extra_css %}
<!-- FontAwesomeå›¾æ ‡åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Bootstrap Iconsä½œä¸ºå¤‡ç”¨ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<!-- HLS.js for better HLS support -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>

<style>
    /* å®æ—¶è½¬ç ç›¸å…³æ ·å¼ */
    .transcoding-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    }
    
    .transcoding-indicator.error {
        background-color: rgba(200, 0, 0, 0.7);
    }
    
    .transcoding-spinner {
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .transcoding-text {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
    }
    
    /* å®æ—¶è½¬ç æŒ‡ç¤ºå™¨æ ·å¼ */
    .realtime-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(76, 175, 80, 0.8);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        z-index: 900;
        transition: opacity 0.5s ease;
    }
    
    .realtime-icon {
        margin-right: 8px;
        color: yellow;
        font-size: 14px;
    }
    
    .realtime-text {
        font-size: 14px;
        font-weight: bold;
    }
    
    /* åˆ†è¾¨ç‡æŒ‰é’®æ ·å¼ */
    .quality-button {
        position: relative;
    }
    
    .quality-menu {
        position: absolute;
        bottom: 45px;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 8px 0;
        min-width: 120px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        z-index: 110;
    }
    
    .quality-menu.active {
        display: flex;
    }
    
    .quality-option {
        padding: 8px 15px;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s ease;
        white-space: nowrap;
        text-align: left;
    }
    
    .quality-option:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .quality-option.selected {
        color: #007bff;
        font-weight: bold;
    }
    
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        max-width: 100%;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .video-container:hover {
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
    }
    
    .video-player {
        width: 100%;
        height: auto;
        max-height: 70vh;
        background: #000;
    }
    
    /* å®Œå…¨éšè—æµè§ˆå™¨é»˜è®¤æ§åˆ¶æ  */
    .video-player::-webkit-media-controls {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-enclosure {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-panel {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-play-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-timeline {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-current-time-display {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-time-remaining-display {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-mute-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-toggle-closed-captions-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-volume-slider {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-fullscreen-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-overlay-enclosure {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-overlay-play-button {
        display: none !important;
    }

    /* è‡ªå®šä¹‰æ’­æ”¾å™¨æ§åˆ¶æ  */
    .custom-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        padding: 15px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
    }
    
    /* æ§åˆ¶æ æ˜¾ç¤ºé€»è¾‘ - æ™®é€šæ¨¡å¼ */
    .video-container:hover .custom-controls,
    .video-container.controls-visible .custom-controls,
    .video-container.paused .custom-controls {
        opacity: 1;
        pointer-events: auto;
    }
    
    /* å…¨å±æ¨¡å¼ä¸‹æ§åˆ¶æ çš„å¼ºåˆ¶éšè— - æœ€é«˜ä¼˜å…ˆçº§ */
    .video-container:fullscreen .custom-controls,
    .video-container:-webkit-full-screen .custom-controls,
    .video-container:-moz-full-screen .custom-controls {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 9999 !important;
        background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.5) 60%, transparent 100%) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        padding: 20px 20px 25px 20px !important;
        transition: opacity 0.3s ease, transform 0.3s ease !important;
        
        /* é»˜è®¤éšè—çŠ¶æ€ */
        opacity: 0 !important;
        transform: translateY(100%) !important;
        pointer-events: none !important;
        visibility: hidden !important;
    }
    
    /* å…¨å±æ¨¡å¼æ˜¾ç¤ºæ§åˆ¶æ çš„æ¡ä»¶ - è¶…é«˜ä¼˜å…ˆçº§ */
    .video-container:fullscreen:hover .custom-controls,
    .video-container:-webkit-full-screen:hover .custom-controls,
    .video-container:-moz-full-screen:hover .custom-controls {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
    }
    
    .video-container:fullscreen.controls-visible .custom-controls,
    .video-container:-webkit-full-screen.controls-visible .custom-controls,
    .video-container:-moz-full-screen.controls-visible .custom-controls {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
    }
    
    .video-container:fullscreen.paused .custom-controls,
    .video-container:-webkit-full-screen.paused .custom-controls,
    .video-container:-moz-full-screen.paused .custom-controls {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
    }
    
    /* è¿›åº¦æ¡å®¹å™¨ */
    .progress-container {
        padding: 0 5px;
        position: relative;
        margin-bottom: 10px;
    }
    
    .progress-bar-custom {
        position: relative;
        width: 100%;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
        cursor: pointer;
        transition: height 0.2s ease, transform 0.1s ease;
    }
    
    .progress-bar-custom:hover {
        height: 6px;
        transform: scaleY(1.2);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #00c6ff);
        border-radius: 2px;
        width: 0%;
        position: relative;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    }
    
    .progress-thumb {
        position: absolute;
        right: -8px;
        top: 50%;
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transform: translateY(-50%) scale(0);
        transition: transform 0.2s ease;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 10;
    }
    
    .progress-bar-custom:hover .progress-thumb {
        transform: translateY(-50%) scale(1);
    }
    
    /* æ§åˆ¶æŒ‰é’®è¡Œ */
    .controls-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: white;
    }
    
    .controls-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .controls-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .control-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 2px;
    }
    
    .control-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: scale(1.1);
        color: #fff;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .control-btn:active {
        transform: scale(0.95);
    }
    
    .time-display {
        font-size: 14px;
        font-family: 'Courier New', monospace;
        margin-left: 10px;
        background: rgba(0,0,0,0.5);
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
        color: #fff;
        font-weight: 500;
    }
    
    .volume-container {
        display: flex;
        align-items: center;
        background: rgba(0,0,0,0.5);
        border-radius: 20px;
        padding: 3px 10px;
        transition: all 0.3s ease;
        overflow: hidden;
        width: auto;
    }
    
    .volume-container:hover {
        background: rgba(0,0,0,0.7);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }
    
    .volume-slider {
        width: 0;
        height: 4px;
        background: rgba(255,255,255,0.3);
        border-radius: 2px;
        outline: none;
        cursor: pointer;
        transition: width 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        margin-left: 0;
    }
    
    .volume-container:hover .volume-slider {
        width: 70px;
        opacity: 1;
        margin-left: 8px;
    }
    
    /* ä¸‹æ‹‰èœå•ç»Ÿä¸€æ ·å¼ - æ¸…ç†ç‰ˆæœ¬ */
    .playback-speed,
    .quality-selector {
        position: relative;
        margin-right: 10px;
    }
    
    /* æ¸…æ™°åº¦æ ‡ç­¾ */
    .quality-label {
        background: linear-gradient(135deg, #0062cc, #0097ff);
        color: white;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
        display: inline-block;
        vertical-align: middle;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    }
    
    .quality-label .current-quality {
        color: white;
        font-weight: 500;
    }
    
    /* æ’­æ”¾é€Ÿåº¦æ˜¾ç¤º */
    .current-speed {
        font-size: 10px;
        margin-left: 3px;
        color: white;
        font-weight: 500;
    }
    
    /* å…¨å±æ¨¡å¼ */
    .video-container:fullscreen {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100vw !important;
        height: 100vh !important;
    }
    
    .video-container:-webkit-full-screen {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100vw !important;
        height: 100vh !important;
    }
    
    .video-container:-moz-full-screen {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100vw !important;
        height: 100vh !important;
    }
    
    /* å…¨å±æ—¶è§†é¢‘æ ·å¼ */
    .video-container:fullscreen .video-player {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        object-fit: contain;
    }
    
    .video-container:-webkit-full-screen .video-player {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        object-fit: contain;
    }
    
    .video-container:-moz-full-screen .video-player {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        object-fit: contain;
    }
    
    /* å…¨å±æç¤ºæ ·å¼ */
    .fullscreen-hint {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 1001;
        backdrop-filter: blur(5px);
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    
    /* åŠ è½½æŒ‡ç¤ºå™¨ */
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
    }
    
    /* è½¬ç æŒ‡ç¤ºå™¨ */
    .transcoding-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        max-width: 400px;
        text-align: center;
    }
    
    /* æ’­æ”¾å™¨æ§åˆ¶æ ä¸‹æ‹‰èœå•æ ·å¼ */
    .custom-controls .dropdown-menu {
        background: rgba(0, 0, 0, 0.95) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        border-radius: 10px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8) !important;
        padding: 8px 0 !important;
        margin: 0 !important;
        display: none !important;
        position: absolute !important;
        top: auto !important;
        bottom: 50px !important;
        right: 0 !important;
        left: auto !important;
        z-index: 9999 !important;
        min-width: 120px !important;
        overflow: hidden !important;
    }
    
    .custom-controls .dropdown-menu.show {
        display: block !important;
    }
    
    .custom-controls .dropdown-item {
        color: rgba(255, 255, 255, 0.9) !important;
        background: transparent !important;
        border: none !important;
        padding: 10px 16px !important;
        margin: 0 !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        transition: all 0.2s ease !important;
        text-decoration: none !important;
        display: block !important;
        width: 100% !important;
        text-align: left !important;
        white-space: nowrap !important;
        border-radius: 0 !important;
    }
    
    .custom-controls .dropdown-item:hover,
    .custom-controls .dropdown-item:focus {
        background: rgba(255, 255, 255, 0.15) !important;
        color: rgba(255, 255, 255, 1) !important;
        box-shadow: none !important;
        outline: none !important;
        transform: translateX(2px) !important;
    }
    
    .custom-controls .dropdown-item.active {
        background: rgba(0, 123, 255, 0.25) !important;
        color: rgba(255, 255, 255, 1) !important;
        position: relative !important;
    }
    
    .custom-controls .dropdown-item.active::after {
        content: 'âœ“' !important;
        position: absolute !important;
        right: 12px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        color: #00d4ff !important;
        font-weight: bold !important;
        font-size: 12px !important;
    }
    
    .custom-controls .dropdown-toggle {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
    }
    
    .custom-controls .dropdown-toggle:focus {
        box-shadow: none !important;
        outline: none !important;
    }
    
    .custom-controls .dropdown-toggle::after {
        display: none !important;
    }
    
    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
        .controls-left, .controls-right {
            gap: 8px;
        }
        
        .control-btn {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
        
        .time-display {
            font-size: 12px;
            padding: 3px 6px;
        }
        
        .quality-label {
            font-size: 10px;
            padding: 1px 4px;
        }
        
        .current-speed {
            font-size: 9px;
        }
        
        /* ç§»åŠ¨ç«¯ä¸‹æ‹‰èœå•ä¼˜åŒ– */
        .custom-controls .dropdown-menu {
            min-width: 100px !important;
            font-size: 12px !important;
        }
        
        .custom-controls .dropdown-item {
            padding: 6px 12px !important;
            font-size: 12px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
        <div class="col-lg-8">
            <!-- å¿«æ·é”®æç¤º -->
            <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="mb-2"><i class="fas fa-keyboard"></i> é”®ç›˜å¿«æ·é”®</h6>
                        <small>
                            <strong>ç©ºæ ¼:</strong> æ’­æ”¾/æš‚åœ &nbsp; 
                            <strong>F:</strong> å…¨å± &nbsp; 
                            <strong>M:</strong> é™éŸ³ &nbsp; 
                            <strong>Esc:</strong> é€€å‡ºå…¨å±
                        </small>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-2"><i class="fas fa-arrows-alt"></i> æ–¹å‘é”®</h6>
                        <small>
                            <strong>â†/â†’:</strong> å¿«é€€/å¿«è¿›10ç§’ &nbsp; 
                            <strong>â†‘/â†“:</strong> è°ƒèŠ‚éŸ³é‡ &nbsp; 
                            <strong>åŒå‡»:</strong> å…¨å±
                        </small>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-2"><i class="fas fa-expand"></i> æ²‰æµ¸å¼å…¨å±</h6>
                        <small>
                            <strong>è‡ªåŠ¨éšè—:</strong> æ§åˆ¶æ 2ç§’åéšè— &nbsp; 
                            <strong>é¼ æ ‡å”¤é†’:</strong> ç§»åŠ¨é¼ æ ‡æ˜¾ç¤º &nbsp; 
                            <strong>ç‚¹å‡»å”¤é†’:</strong> å•å‡»å±å¹•æ˜¾ç¤º
                        </small>
                    </div>
                </div>
            </div>

            <!-- è§†é¢‘æ’­æ”¾å™¨ -->
            <div class="video-container mb-4" id="videoContainer">
                <video class="video-player" id="moviePlayer" preload="metadata" poster="{% if movie.thumbnail %}{{ movie.thumbnail.url }}{% endif %}">
                    <source src="{% url 'serve_video' movie.pk %}" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHTML5è§†é¢‘æ’­æ”¾ã€‚
                </video>
                
                <!-- è‡ªå®šä¹‰æ§åˆ¶æ  -->
                <div class="custom-controls" id="customControls">
                    <div class="progress-container">
                        <div class="progress-bar-custom" id="progressBar">
                            <div class="progress-fill" id="progressFill">
                                <div class="progress-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div class="controls-left">
                            <button class="control-btn play-pause-btn" id="playPauseBtn" title="æ’­æ”¾">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="control-btn rewind-btn" id="rewindBtn" title="å¿«é€€10ç§’">
                                <i class="fas fa-undo-alt"></i>
                            </button>
                            <button class="control-btn forward-btn" id="forwardBtn" title="å¿«è¿›10ç§’">
                                <i class="fas fa-redo-alt"></i>
                            </button>
                            <div class="volume-container">
                                <button class="control-btn mute-btn" id="muteBtn" title="é™éŸ³">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                            </div>
                            <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                        </div>
                        <div class="controls-right">
                            <!-- æ’­æ”¾é€Ÿåº¦æ§åˆ¶ -->
                            <div class="playback-speed dropdown">
                                <button class="control-btn" id="speedBtn" title="æ’­æ”¾é€Ÿåº¦">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span class="current-speed" id="currentSpeed">1.0x</span>
                                </button>
                                <div class="dropdown-menu playback-speed-menu dropdown-menu-end" id="speedMenu">
                                    <a class="dropdown-item" data-speed="0.5" href="#">0.5x</a>
                                    <a class="dropdown-item" data-speed="0.75" href="#">0.75x</a>
                                    <a class="dropdown-item active" data-speed="1.0" href="#">1.0x</a>
                                    <a class="dropdown-item" data-speed="1.25" href="#">1.25x</a>
                                    <a class="dropdown-item" data-speed="1.5" href="#">1.5x</a>
                                    <a class="dropdown-item" data-speed="2.0" href="#">2.0x</a>
                                </div>
                            </div>
                            
                            <!-- ç”»ä¸­ç”»æŒ‰é’® -->
                            <button class="control-btn pip-btn" id="pipBtn" title="ç”»ä¸­ç”»">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            
                            <!-- æ¸…æ™°åº¦é€‰æ‹© - æ‰‹åŠ¨æ§åˆ¶ç‰ˆæœ¬ -->
                            <div class="quality-selector dropdown">
                                <button class="control-btn" id="qualityBtn" title="æ¸…æ™°åº¦">
                                    <i class="fas fa-cog"></i>
                                    <span class="quality-label">
                                        <span class="current-quality" id="currentQuality">åŸç”»</span>
                                    </span>
                                </button>
                                <div class="dropdown-menu quality-menu dropdown-menu-end" id="qualityMenu">
                                    <!-- åˆ†è¾¨ç‡é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                                </div>
                            </div>
                            
                            <!-- å…¨å±æŒ‰é’® -->
                            <button class="control-btn fullscreen-btn" id="fullscreenBtn" title="å…¨å±">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                </div>
                
                <!-- å…¨å±æç¤º -->
                <div class="fullscreen-hint" id="fullscreenHint" style="opacity: 0;">
                    <i class="fas fa-keyboard"></i> æŒ‰ <b>F</b> å¯é€€å‡ºå…¨å±
                </div>
                
                <!-- è½¬ç æŒ‡ç¤ºå™¨ -->
                <div class="transcoding-indicator" id="transcodingIndicator" style="display: none;">
                    <div class="card bg-dark text-white p-3">
                        <h5><i class="fas fa-cog fa-spin"></i> æ­£åœ¨å¤„ç†è§†é¢‘</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="transcodingProgress" style="width: 100%"></div>
                        </div>
                        <p class="transcoding-status" id="transcodingStatus">æ­£åœ¨è½¬ç ä¸º720p...</p>
                        <p class="transcoding-time" id="transcodingTime">è½¬ç æ—¶é—´: 0ç§’</p>
                        <small class="text-muted">é¦–æ¬¡è½¬ç éœ€è¦ç­‰å¾…ï¼Œç¨åè§‚çœ‹å°†ç›´æ¥æ’­æ”¾</small>
                    </div>
                </div>
            </div>
            
            <!-- å½±ç‰‡ä¿¡æ¯ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">{{ movie.title }}</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>æ–‡ä»¶åï¼š</strong> {{ movie.file_name }}</p>
                            <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong> {{ movie.file_size_mb }} MB</p>
                            {% if movie.duration %}
                            <p><strong>æ—¶é•¿ï¼š</strong> {{ movie.duration }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if movie.genre %}
                            <p><strong>ç±»å‹ï¼š</strong> 
                                <span class="badge bg-secondary">{{ movie.genre }}</span>
                            </p>
                            {% endif %}
                            {% if movie.year %}
                            <p><strong>å¹´ä»½ï¼š</strong> {{ movie.year }}</p>
                            {% endif %}
                            <p><strong>è§‚çœ‹æ¬¡æ•°ï¼š</strong> {{ movie.views }}</p>
                        </div>
                    </div>
                    
                    {% if movie.description %}
                    <div class="mb-3">
                        <h5>ç®€ä»‹</h5>
                        <p>{{ movie.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if avg_rating %}
                    <div class="mb-3">
                        <h5>å¹³å‡è¯„åˆ†</h5>
                        <div class="rating-stars">
                            {% for i in "12345" %}
                            {% if forloop.counter <= avg_rating %}
                            <i class="bi bi-star-fill"></i>
                            {% else %}
                            <i class="bi bi-star"></i>
                            {% endif %}
                            {% endfor %}
                            <span class="ms-2">{{ avg_rating|floatformat:1 }}/5.0</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ  -->
        <div class="col-lg-4">
            {% if user.is_authenticated %}
            <!-- è¯„åˆ†è¡¨å• -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-star"></i> ä¸ºè¿™éƒ¨å½±ç‰‡è¯„åˆ†
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'rate_movie' movie.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ rating_form.rating.label_tag }}
                            {{ rating_form.rating }}
                        </div>
                        <div class="mb-3">
                            {{ rating_form.comment.label_tag }}
                            {{ rating_form.comment }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-send"></i> æäº¤è¯„åˆ†
                        </button>
                    </form>
                    
                    {% if user_rating %}
                    <hr>
                    <div class="alert alert-info">
                        <strong>æ‚¨çš„è¯„åˆ†ï¼š</strong>
                        <div class="rating-stars">
                            {% for i in "12345" %}
                            {% if forloop.counter <= user_rating.rating %}
                            <i class="bi bi-star-fill"></i>
                            {% else %}
                            <i class="bi bi-star"></i>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% if user_rating.comment %}
                        <p class="mt-2 mb-0">{{ user_rating.comment }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- è§‚çœ‹è¿›åº¦ -->
            {% if watch_history and watch_history.progress %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> è§‚çœ‹è¿›åº¦
                    </h5>
                </div>
                <div class="card-body">
                    <p>ä¸Šæ¬¡è§‚çœ‹åˆ°ï¼š{{ watch_history.progress }}</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="resumeFromProgress()">
                        <i class="bi bi-play"></i> ç»§ç»­è§‚çœ‹
                    </button>
                </div>
            </div>
            {% endif %}
            {% else %}
            <!-- ç™»å½•æç¤º -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5>ç™»å½•åå¯ä»¥</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-star text-warning"></i> è¯„åˆ†å’Œè¯„è®º</li>
                        <li><i class="bi bi-clock-history text-info"></i> ä¿å­˜è§‚çœ‹è¿›åº¦</li>
                        <li><i class="bi bi-heart text-danger"></i> æ”¶è—å½±ç‰‡</li>
                    </ul>
                    <a href="{% url 'login' %}" class="btn btn-primary">ç«‹å³ç™»å½•</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- è¯„è®ºåŒºåŸŸ -->
    {% if ratings %}
    <div class="row mt-4">
        <div class="col-12">
            <h4>ç”¨æˆ·è¯„è®º</h4>
            {% for rating in ratings %}
            <div class="comment-card card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">{{ rating.user.username }}</h6>
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                {% if forloop.counter <= rating.rating %}
                                <i class="bi bi-star-fill"></i>
                                {% else %}
                                <i class="bi bi-star"></i>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <small class="text-muted">{{ rating.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    {% if rating.comment %}
                    <p class="card-text mt-2">{{ rating.comment }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è·å–å…ƒç´ å¼•ç”¨
    const player = document.getElementById('moviePlayer');
    const videoContainer = document.getElementById('videoContainer');
    const customControls = document.getElementById('customControls');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const timeDisplay = document.getElementById('timeDisplay');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const pipBtn = document.getElementById('pipBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const qualityBtn = document.getElementById('qualityBtn');
    const qualityMenu = document.getElementById('qualityMenu');
    const currentQualitySpan = document.getElementById('currentQuality');
    const speedMenu = document.getElementById('speedMenu');
    const speedBtn = document.getElementById('speedBtn');
    const currentSpeedSpan = document.getElementById('currentSpeed');
    const speedItems = document.querySelectorAll('#speedMenu .dropdown-item');
    const transcodingIndicator = document.getElementById('transcodingIndicator');
    const transcodingStatus = document.getElementById('transcodingStatus');
    const transcodingProgress = document.getElementById('transcodingProgress');
    const transcodingTime = document.getElementById('transcodingTime');
    const fullscreenHint = document.getElementById('fullscreenHint');

    // çŠ¶æ€å˜é‡
    let progressUpdateInterval;
    let controlsTimeout;
    let isTogglingPlayPause = false;
    let isDragging = false;
    let isFullscreen = false;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let currentTranscodeId = null;
    let transcodingInterval = null;
    let currentQuality = "åŸç”»";
    let controlsVisible = false;

    // åˆå§‹åŒ–æ’­æ”¾å™¨çŠ¶æ€
    function initializePlayerState() {
        // å®Œå…¨ç¦ç”¨æµè§ˆå™¨é»˜è®¤æ§åˆ¶æ 
        player.controls = false;
        player.disablePictureInPicture = false;
        
        // ç¡®ä¿æ’­æ”¾/æš‚åœæŒ‰é’®çŠ¶æ€æ­£ç¡®
        if (player.paused) {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.title = 'æ’­æ”¾';
        } else {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.title = 'æš‚åœ';
        }
        
        // è®¾ç½®éŸ³é‡æ»‘å—
        volumeSlider.value = player.volume;
        
        // è®¾ç½®é™éŸ³æŒ‰é’®çŠ¶æ€
        updateMuteButton();
        
        console.log('ğŸ”§ æ’­æ”¾å™¨çŠ¶æ€å·²åˆå§‹åŒ–');
    }

    // æ˜¾ç¤ºæ§åˆ¶æ  - ä¿®å¤ç‰ˆæœ¬
    function showControls() {
        if (controlsTimeout) {
            clearTimeout(controlsTimeout);
        }
        
        //console.log('ğŸ® æ˜¾ç¤ºæ§åˆ¶æ ï¼Œå…¨å±çŠ¶æ€:', isFullscreen, 'æš‚åœçŠ¶æ€:', player.paused);
        
        controlsVisible = true;
        videoContainer.classList.add('controls-visible');
        
        // åªæœ‰åœ¨è§†é¢‘çœŸæ­£æš‚åœæ—¶æ‰æ·»åŠ pausedç±»
        if (player.paused) {
            videoContainer.classList.add('paused');
        }
        
        videoContainer.style.cursor = 'default';
        
        // å¦‚æœè§†é¢‘æ­£åœ¨æ’­æ”¾ï¼Œè®¾ç½®è‡ªåŠ¨éšè—
        if (player && !player.paused && !isMouseOverControls()) {
            controlsTimeout = setTimeout(() => {
                hideControls();
            }, 3000);
        }
    }

    // éšè—æ§åˆ¶æ  - ä¿®å¤ç‰ˆæœ¬
    function hideControls() {
        console.log('ğŸ™ˆ å°è¯•éšè—æ§åˆ¶æ ï¼Œå…¨å±çŠ¶æ€:', isFullscreen, 'æš‚åœçŠ¶æ€:', player.paused, 'é¼ æ ‡åœ¨æ§åˆ¶æ ä¸Š:', isMouseOverControls());
        
        // å¦‚æœè§†é¢‘æš‚åœæˆ–é¼ æ ‡åœ¨æ§åˆ¶æ ä¸Šï¼Œä¸éšè—
        if (player.paused || isMouseOverControls()) {
            console.log('ğŸš« æ§åˆ¶æ éšè—è¢«é˜»æ­¢');
            return;
        }
        
        controlsVisible = false;
        videoContainer.classList.remove('controls-visible');
        
        // ç§»é™¤pausedç±»ï¼Œç¡®ä¿å…¨å±æ—¶èƒ½éšè—
        if (!player.paused) {
            videoContainer.classList.remove('paused');
        }
        
        // å…¨å±æ¨¡å¼ä¸‹éšè—é¼ æ ‡æŒ‡é’ˆ
        if (isFullscreen) {
            videoContainer.style.cursor = 'none';
            console.log('ğŸ–±ï¸ å…¨å±æ¨¡å¼ï¼šéšè—é¼ æ ‡æŒ‡é’ˆ');
        }
        
        console.log('âœ… æ§åˆ¶æ å·²éšè—');
    }
    
    // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨æ§åˆ¶æ ä¸Š
    function isMouseOverControls() {
        return document.querySelector('.custom-controls:hover') !== null ||
               document.querySelector('.dropdown-menu.show') !== null;
    }

    // åˆ‡æ¢å…¨å±æ¨¡å¼
    function toggleFullscreen() {
        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
            // é€€å‡ºå…¨å±
            console.log('ğŸ”™ é€€å‡ºå…¨å±æ¨¡å¼');
            
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'å…¨å±';
            
            // æ¢å¤æ™®é€šæ¨¡å¼æ ·å¼
            videoContainer.style.cursor = 'default';
            if (player.paused) {
                showControls();
            } else {
                hideControls();
            }
            
        } else {
            // è¿›å…¥å…¨å±
            console.log('ğŸ” è¿›å…¥å…¨å±æ¨¡å¼');
            
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            } else if (videoContainer.webkitRequestFullscreen) {
                videoContainer.webkitRequestFullscreen();
            } else if (videoContainer.mozRequestFullScreen) {
                videoContainer.mozRequestFullScreen();
            }
            
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = 'é€€å‡ºå…¨å±';
            
            // æ˜¾ç¤ºå…¨å±æç¤º
            fullscreenHint.style.opacity = '1';
            setTimeout(() => {
                fullscreenHint.style.opacity = '0';
            }, 3000);
            
            // çŸ­æš‚æ˜¾ç¤ºæ§åˆ¶æ åéšè—
            showControls();
            setTimeout(() => {
                if (!player.paused) {
                    console.log('â° 3ç§’åè‡ªåŠ¨éšè—æ§åˆ¶æ ');
                    hideControls();
                }
            }, 3000);
        }
    }

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress() {
        if (player.duration) {
            const progress = (player.currentTime / player.duration) * 100;
            progressFill.style.width = `${progress}%`;
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateTimeDisplay();
            
            // æ£€æŸ¥æ˜¯å¦å·²çœ‹å®Œï¼Œå¦‚éœ€è®°å½•è§‚çœ‹è¿›åº¦
            if (progress > 95) {
                console.log('è§†é¢‘å·²çœ‹å®Œ');
                // å¯ä»¥æ·»åŠ å‘é€è§‚çœ‹å®Œæˆè®°å½•çš„é€»è¾‘
            }
        }
    }

    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateTimeDisplay() {
        const currentTime = formatTime(player.currentTime);
        const duration = formatTime(player.duration);
        timeDisplay.textContent = `${currentTime} / ${duration}`;
    }

    // æ—¶é—´æ ¼å¼åŒ–
    function formatTime(seconds) {
        if (isNaN(seconds) || !isFinite(seconds)) {
            return '00:00';
        }
        
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // æ›´æ–°é™éŸ³æŒ‰é’®çŠ¶æ€
    function updateMuteButton() {
        if (player.muted || player.volume === 0) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            muteBtn.title = 'å–æ¶ˆé™éŸ³';
        } else if (player.volume < 0.5) {
            muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
            muteBtn.title = 'é™éŸ³';
        } else {
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            muteBtn.title = 'é™éŸ³';
        }
    }

    // ä»é¼ æ ‡ä½ç½®æ›´æ–°è¿›åº¦æ¡
    function updateProgressFromMouse(e) {
        const rect = progressBar.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const progress = Math.max(0, Math.min(1, clickX / rect.width));
        
        // æ£€æŸ¥è§†é¢‘æ˜¯å¦å·²åŠ è½½è¶³å¤Ÿçš„æ•°æ®
        if (player.duration && player.readyState >= 2) {
            player.currentTime = progress * player.duration;
            updateProgress();
        }
    }

    // æµ‹è¯•APIè¿æ¥
    function testApiConnection() {
        console.log('ğŸ” [å‰ç«¯DEBUG] æµ‹è¯•APIè¿æ¥...');
        
        fetch('/api/test/')
            .then(response => {
                console.log('ğŸ“¡ [å‰ç«¯DEBUG] æµ‹è¯•APIå“åº”çŠ¶æ€:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('âœ… [å‰ç«¯DEBUG] æµ‹è¯•APIå“åº”:', data);
            })
            .catch(error => {
                console.error('âŒ [å‰ç«¯DEBUG] æµ‹è¯•APIå¤±è´¥:', error);
            });
    }

    // åŠ è½½å¯ç”¨çš„åˆ†è¾¨ç‡é€‰é¡¹
    function loadAvailableResolutions() {
        console.log('ğŸ” [å‰ç«¯DEBUG] æ£€æµ‹å¯ç”¨åˆ†è¾¨ç‡...');
        console.log('ğŸ”— [å‰ç«¯DEBUG] è¯·æ±‚URL:', `/api/{{ movie.pk }}/resolutions/`);
        
        // å…ˆæµ‹è¯•APIè¿æ¥
        testApiConnection();
        
        fetch(`/api/{{ movie.pk }}/resolutions/`)
            .then(response => {
                console.log('ğŸ“¡ [å‰ç«¯DEBUG] åˆ†è¾¨ç‡APIå“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('âœ… [å‰ç«¯DEBUG] åˆ†è¾¨ç‡APIå“åº”æˆåŠŸ:', data);
                
                if (data.success && data.resolutions.length > 0) {
                    console.log('âœ… [å‰ç«¯DEBUG] è·å–å¯ç”¨åˆ†è¾¨ç‡æˆåŠŸ:', data.resolutions);
                    console.log('ğŸ“º [å‰ç«¯DEBUG] åŸå§‹è§†é¢‘ä¿¡æ¯:', data.original_info);
                    
                    // æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨åˆ†è¾¨ç‡
                    const items = qualityMenu.querySelectorAll('.dropdown-item');
                    items.forEach(item => {
                        const quality = item.dataset.quality;
                        if (quality === 'åŸç”»' || data.resolutions.includes(quality)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                } else {
                    console.log('âš ï¸ [å‰ç«¯DEBUG] æ²¡æœ‰å¯ç”¨çš„è½¬ç é€‰é¡¹ï¼Œä½¿ç”¨åŸç”»æ’­æ”¾');
                }
            })
            .catch(error => {
                console.error('âŒ [å‰ç«¯DEBUG] è·å–å¯ç”¨åˆ†è¾¨ç‡å¤±è´¥:', error);
                console.error('âŒ [å‰ç«¯DEBUG] è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error.message);
            });
    }

    // åˆ†è¾¨ç‡åˆ‡æ¢å‡½æ•°
    function switchVideoResolution(resolution) {
        console.log('ğŸ”„ [å‰ç«¯DEBUG] åˆ‡æ¢åˆ†è¾¨ç‡åˆ°:', resolution);
        
        // ä¿å­˜å½“å‰æ’­æ”¾çŠ¶æ€
        const currentTime = player.currentTime;
        const wasPlaying = !player.paused;
        
        if (resolution === 'åŸç”»') {
            // åˆ‡æ¢å›åŸç”»
            console.log('ğŸ“º [å‰ç«¯DEBUG] åˆ‡æ¢åˆ°åŸç”»è´¨é‡');
            player.src = "{% url 'serve_video' movie.pk %}";
            player.currentTime = currentTime;
            if (wasPlaying) {
                player.play();
            }
        } else {
            // è¯·æ±‚å®æ—¶è½¬ç 
            console.log('ğŸš€ [å‰ç«¯DEBUG] è¯·æ±‚å®æ—¶è½¬ç :', resolution);
            requestRealtimeTranscode(resolution, currentTime, wasPlaying);
        }
    }

    // è¯·æ±‚å®æ—¶è½¬ç 
    function requestRealtimeTranscode(resolution, currentTime, wasPlaying) {
        console.log('ğŸ”¥ [å‰ç«¯DEBUG] å¼€å§‹å®æ—¶è½¬ç è¯·æ±‚:', resolution);
        
        // æ˜¾ç¤ºè½¬ç æç¤º
        showTranscodingIndicator();
        updateTranscodingStatus(`æ­£åœ¨å‡†å¤‡ ${resolution} å®æ—¶è½¬ç ...`);
        
        const apiUrl = `/api/{{ movie.pk }}/realtime/${resolution}/`;
        console.log('ğŸ”— [å‰ç«¯DEBUG] è½¬ç API URL:', apiUrl);
        
        fetch(apiUrl)
            .then(response => {
                console.log('ğŸ“¡ [å‰ç«¯DEBUG] è½¬ç APIå“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“¡ [å‰ç«¯DEBUG] è½¬ç APIå“åº”:', data);
                
                if (data.success) {
                    if (data.realtime) {
                        console.log('âœ… [å‰ç«¯DEBUG] å®æ—¶è½¬ç ä¼šè¯åˆ›å»ºæˆåŠŸ:', data.session_id);
                        
                        // ä¿å­˜ä¼šè¯ID
                        window.realtimeSessionId = data.session_id;
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        if (data.rtx_optimized) {
                            updateTranscodingStatus(`RTX 3070 æ­£åœ¨å®æ—¶è½¬ç  ${resolution}...`);
                        } else {
                            updateTranscodingStatus(`æ­£åœ¨å®æ—¶è½¬ç  ${resolution}...`);
                        }
                        
                        // ç­‰å¾…å‡ ç§’åæ£€æŸ¥HLSæµ
                        setTimeout(() => {
                            loadRealtimeHLS(resolution, data.session_id, currentTime, wasPlaying);
                        }, 3000);
                        
                    } else {
                        // åŸç”»ä¸éœ€è¦è½¬ç 
                        hideTranscodingIndicator();
                        console.log('ğŸ“º [å‰ç«¯DEBUG] åŸç”»è´¨é‡ï¼Œæ— éœ€è½¬ç ');
                    }
                } else {
                    hideTranscodingIndicator();
                    console.error('âŒ [å‰ç«¯DEBUG] è½¬ç è¯·æ±‚å¤±è´¥:', data.error);
                    alert(`è½¬ç è¯·æ±‚å¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                hideTranscodingIndicator();
                console.error('âŒ [å‰ç«¯DEBUG] è½¬ç è¯·æ±‚ç½‘ç»œé”™è¯¯:', error);
                console.error('âŒ [å‰ç«¯DEBUG] é”™è¯¯è¯¦æƒ…:', error.message);
                alert('è½¬ç è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
    }

    // åŠ è½½å®æ—¶HLSæµ - ä¿®å¤ç‰ˆæœ¬
    function loadRealtimeHLS(resolution, sessionId, currentTime, wasPlaying) {
        console.log('ğŸ“º [å®æ—¶è½¬ç ] å¼€å§‹åŠ è½½HLSæµ:', resolution, sessionId);
        
        let retryCount = 0;
        const maxRetries = 15; // æœ€å¤šé‡è¯•15æ¬¡ (çº¦30ç§’)
        
        function attemptLoad() {
            console.log(`ğŸ”„ [å®æ—¶è½¬ç ] å°è¯•åŠ è½½HLSæµ (${retryCount + 1}/${maxRetries})`);
            
            fetch(`/api/{{ movie.pk }}/realtime/${resolution}/${sessionId}/`)
                .then(response => {
                    console.log('ğŸ“¡ [å®æ—¶è½¬ç ] HLS APIå“åº”çŠ¶æ€:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸï¸ [å®æ—¶è½¬ç ] HLSæµå“åº”:', data);
                    
                    if (data.success && data.hls_url) {
                        console.log('âœ… [å®æ—¶è½¬ç ] HLSæµå‡†å¤‡å°±ç»ªï¼ŒURL:', data.hls_url);
                        
                        // ä½¿ç”¨HLS.jsåº“æ¥å¤„ç†HLSæµ
                        if (window.Hls && Hls.isSupported()) {
                            // ä½¿ç”¨HLS.js
                            if (window.hlsInstance) {
                                window.hlsInstance.destroy();
                            }
                            
                            window.hlsInstance = new Hls({
                                debug: false,
                                enableWorker: true,
                                liveSyncDurationCount: 3,
                                liveMaxLatencyDurationCount: 5,
                                manifestLoadingTimeOut: 10000,
                                manifestLoadingMaxRetry: 4,
                                levelLoadingTimeOut: 10000,
                                fragLoadingTimeOut: 20000
                            });
                            
                            // ç›´æ¥åŠ è½½HLS URL
                            window.hlsInstance.loadSource(data.hls_url);
                            window.hlsInstance.attachMedia(player);
                            
                            window.hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                console.log('ğŸ¯ [å®æ—¶è½¬ç ] HLSæ¸…å•è§£æå®Œæˆ');
                                player.currentTime = currentTime;
                                
                                if (wasPlaying) {
                                    player.play().then(() => {
                                        console.log('â–¶ï¸ [å®æ—¶è½¬ç ] å¼€å§‹æ’­æ”¾HLSæµ');
                                    }).catch(error => {
                                        console.error('âŒ [å®æ—¶è½¬ç ] æ’­æ”¾å¤±è´¥:', error);
                                    });
                                }
                                
                                hideTranscodingIndicator();
                                showRealtimeIndicator(resolution);
                                console.log('ğŸ‰ [å®æ—¶è½¬ç ] æ’­æ”¾æˆåŠŸ!');
                            });
                            
                            window.hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                                console.error('âŒ [å®æ—¶è½¬ç ] HLSé”™è¯¯:', data);
                                if (data.fatal) {
                                    hideTranscodingIndicator();
                                    alert('è§†é¢‘æµæ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•');
                                }
                            });
                            
                        } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                            // åŸç”Ÿæ”¯æŒHLS (Safari)
                            console.log('ğŸ [å®æ—¶è½¬ç ] ä½¿ç”¨åŸç”ŸHLSæ”¯æŒ');
                            
                            player.src = data.hls_url;
                            player.currentTime = currentTime;
                            
                            if (wasPlaying) {
                                player.play();
                            }
                            
                            hideTranscodingIndicator();
                            showRealtimeIndicator(resolution);
                            console.log('ğŸ‰ [å®æ—¶è½¬ç ] åŸç”ŸHLSæ’­æ”¾æˆåŠŸ!');
                        } else {
                            console.error('âŒ [å®æ—¶è½¬ç ] æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾');
                            hideTranscodingIndicator();
                            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHLSè§†é¢‘æµæ’­æ”¾');
                        }
                        
                    } else {
                        console.warn(`âš ï¸ [å®æ—¶è½¬ç ] HLSæµæœªå‡†å¤‡å¥½ (${retryCount + 1}/${maxRetries})`);
                        updateTranscodingStatus(`${resolution} è½¬ç è¿›è¡Œä¸­... (${retryCount + 1}/${maxRetries})`);
                        
                        retryCount++;
                        if (retryCount < maxRetries) {
                            // 2ç§’åé‡è¯•
                            setTimeout(attemptLoad, 2000);
                        } else {
                            console.error('âŒ [å®æ—¶è½¬ç ] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                            hideTranscodingIndicator();
                            alert('è½¬ç è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•æˆ–é€‰æ‹©å…¶ä»–åˆ†è¾¨ç‡');
                        }
                    }
                })
                .catch(error => {
                    console.error('âŒ [å®æ—¶è½¬ç ] ç½‘ç»œé”™è¯¯:', error);
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.log(`ğŸ”„ [å®æ—¶è½¬ç ] ç½‘ç»œé”™è¯¯ï¼Œ2ç§’åé‡è¯• (${retryCount}/${maxRetries})`);
                        updateTranscodingStatus(`ç½‘ç»œé”™è¯¯ï¼Œæ­£åœ¨é‡è¯•... (${retryCount}/${maxRetries})`);
                        setTimeout(attemptLoad, 2000);
                    } else {
                        hideTranscodingIndicator();
                        alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                    }
                });
        }
        
        // å¼€å§‹é¦–æ¬¡å°è¯•
        attemptLoad();
    }

    // æ˜¾ç¤ºè½¬ç æŒ‡ç¤ºå™¨
    function showTranscodingIndicator() {
        const indicator = document.getElementById('transcodingIndicator');
        if (indicator) {
            indicator.style.display = 'block';
        }
    }

    // éšè—è½¬ç æŒ‡ç¤ºå™¨
    function hideTranscodingIndicator() {
        const indicator = document.getElementById('transcodingIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    // æ›´æ–°è½¬ç çŠ¶æ€
    function updateTranscodingStatus(message) {
        const statusElement = document.getElementById('transcodingStatus');
        if (statusElement) {
            statusElement.textContent = message;
        }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    // =============
    
    // ç§»åŠ¨é¼ æ ‡æ—¶æ˜¾ç¤ºæ§åˆ¶æ 
    videoContainer.addEventListener('mousemove', function(e) {
        //console.log('ğŸ–±ï¸ é¼ æ ‡ç§»åŠ¨ï¼Œå…¨å±çŠ¶æ€:', isFullscreen);
        showControls();
    });
    
    videoContainer.addEventListener('click', function(e) {
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ§åˆ¶æŒ‰é’®ï¼Œåˆ™åˆ‡æ¢æ’­æ”¾/æš‚åœ
        if (!e.target.closest('.custom-controls')) {
            playPauseBtn.click();
        }
        showControls();
    });

    // é¼ æ ‡ç¦»å¼€è§†é¢‘åŒºåŸŸæ—¶çš„å¤„ç†
    videoContainer.addEventListener('mouseleave', function() {
        if (isFullscreen && !player.paused) {
            //console.log('ğŸ–±ï¸ é¼ æ ‡ç¦»å¼€å…¨å±åŒºåŸŸï¼Œ2ç§’åéšè—æ§åˆ¶æ ');
            setTimeout(() => {
                if (isFullscreen && !player.paused && !isMouseOverControls()) {
                    hideControls();
                }
            }, 2000);
        }
    });

    // é”®ç›˜å¿«æ·é”® - ä¿®å¤ç‰ˆæœ¬
    document.addEventListener('keydown', function(e) {
        // é¿å…åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘å¿«æ·é”®
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }

        // ç¡®ä¿æ’­æ”¾å™¨å·²åŠ è½½
        if (!player) return;

        switch(e.code) {
            case 'Space':
                e.preventDefault();
                if (playPauseBtn) {
                    playPauseBtn.click();
                }
                showControls();
                break;
            case 'KeyF':
                e.preventDefault();
                toggleFullscreen();
                break;
            case 'KeyM':
                e.preventDefault();
                if (muteBtn) {
                    muteBtn.click();
                }
                showControls();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                if (rewindBtn) {
                    rewindBtn.click();
                }
                showControls();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (forwardBtn) {
                    forwardBtn.click();
                }
                showControls();
                break;
            case 'ArrowUp':
                e.preventDefault();
                if (player.volume !== undefined) {
                    player.volume = Math.min(1, player.volume + 0.1);
                    if (volumeSlider) volumeSlider.value = player.volume;
                    updateMuteButton();
                }
                showControls();
                break;
            case 'ArrowDown':
                e.preventDefault();
                if (player.volume !== undefined) {
                    player.volume = Math.max(0, player.volume - 0.1);
                    if (volumeSlider) volumeSlider.value = player.volume;
                    updateMuteButton();
                }
                showControls();
                break;
            case 'Escape':
                if (isFullscreen) {
                    toggleFullscreen();
                }
                break;
        }
    });

    // åŒå‡»å…¨å±
    player.addEventListener('dblclick', function() {
        toggleFullscreen();
    });

    // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
    document.addEventListener('fullscreenchange', function() {
        if (!document.fullscreenElement) {
            console.log('ğŸ”„ å…¨å±çŠ¶æ€å˜åŒ–ï¼šé€€å‡ºå…¨å±');
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'å…¨å±';
            videoContainer.style.cursor = 'default';
        } else {
            console.log('ğŸ”„ å…¨å±çŠ¶æ€å˜åŒ–ï¼šè¿›å…¥å…¨å±');
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = 'é€€å‡ºå…¨å±';
        }
    });

    document.addEventListener('webkitfullscreenchange', function() {
        if (!document.webkitFullscreenElement) {
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'å…¨å±';
            videoContainer.style.cursor = 'default';
        } else {
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = 'é€€å‡ºå…¨å±';
        }
    });

    document.addEventListener('mozfullscreenchange', function() {
        if (!document.mozFullScreenElement) {
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'å…¨å±';
            videoContainer.style.cursor = 'default';
        } else {
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = 'é€€å‡ºå…¨å±';
        }
    });

    // æ’­æ”¾å™¨äº‹ä»¶
    player.addEventListener('loadedmetadata', function() {
        updateTimeDisplay();
        loadingIndicator.style.display = 'none';
    });

    player.addEventListener('play', function() {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        playPauseBtn.title = 'æš‚åœ';
        
        // å¼€å§‹æ›´æ–°è¿›åº¦æ¡
        progressUpdateInterval = setInterval(updateProgress, 100);
        
        // ç§»é™¤æš‚åœçŠ¶æ€
        videoContainer.classList.remove('paused');
        
        // æ’­æ”¾æ—¶çŸ­æš‚æ˜¾ç¤ºæ§åˆ¶æ åéšè—
        showControls();
        setTimeout(() => {
            hideControls();
        }, 3000);
    });

    player.addEventListener('pause', function() {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.title = 'æ’­æ”¾';
        
        // åœæ­¢æ›´æ–°è¿›åº¦æ¡
        clearInterval(progressUpdateInterval);
        
        // æš‚åœæ—¶å§‹ç»ˆæ˜¾ç¤ºæ§åˆ¶æ 
        videoContainer.classList.add('paused');
        showControls();
    });

    player.addEventListener('timeupdate', updateProgress);

    player.addEventListener('waiting', function() {
        loadingIndicator.style.display = 'block';
    });

    player.addEventListener('canplay', function() {
        loadingIndicator.style.display = 'none';
    });

    player.addEventListener('ended', function() {
        playPauseBtn.innerHTML = '<i class="fas fa-redo"></i>';
        playPauseBtn.title = 'é‡æ–°æ’­æ”¾';
        clearInterval(progressUpdateInterval);
        
        // æ’­æ”¾ç»“æŸæ—¶æ˜¾ç¤ºæ§åˆ¶æ 
        videoContainer.classList.add('paused');
        showControls();
    });
    
    // è¿›åº¦æ¡äº¤äº’
    progressBar.addEventListener('click', updateProgressFromMouse);
    
    // è¿›åº¦æ¡æ‹–æ‹½
    progressBar.addEventListener('mousedown', function(e) {
        isDragging = true;
        updateProgressFromMouse(e);
        showControls();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (isDragging) {
            updateProgressFromMouse(e);
        }
    });
    
    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    // æ§åˆ¶æ äº‹ä»¶
    playPauseBtn.addEventListener('click', function() {
        if (isTogglingPlayPause) return;
        
        isTogglingPlayPause = true;
        
        if (player.paused) {
            player.play().then(() => {
                isTogglingPlayPause = false;
            }).catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                alert('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§†é¢‘æ–‡ä»¶');
                isTogglingPlayPause = false;
            });
        } else {
            player.pause();
            isTogglingPlayPause = false;
        }
    });

    // æ¸…æ™°åº¦é€‰æ‹©å™¨æ‰‹åŠ¨æ§åˆ¶
    qualityBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('ğŸ›ï¸ [å‰ç«¯DEBUG] ç‚¹å‡»æ¸…æ™°åº¦æŒ‰é’®');
        
        const isOpen = qualityMenu.classList.contains('show');
        
        // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå•
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
        
        // åˆ‡æ¢å½“å‰èœå•
        if (!isOpen) {
            qualityMenu.classList.add('show');
            console.log('âœ… [å‰ç«¯DEBUG] æ¸…æ™°åº¦èœå•å·²æ‰“å¼€');
        } else {
            qualityMenu.classList.remove('show');
            console.log('âŒ [å‰ç«¯DEBUG] æ¸…æ™°åº¦èœå•å·²å…³é—­');
        }
        
        showControls();
    });

    // æ¸…æ™°åº¦é€‰é¡¹ç‚¹å‡»äº‹ä»¶
    qualityMenu.addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
            e.preventDefault();
            e.stopPropagation();
            
            const quality = e.target.dataset.quality;
            console.log('ğŸ¬ [å‰ç«¯DEBUG] é€‰æ‹©æ¸…æ™°åº¦:', quality);
            
            // æ›´æ–°å½“å‰æ˜¾ç¤º
            currentQualitySpan.textContent = quality;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            qualityMenu.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            e.target.classList.add('active');
            
            // å…³é—­èœå•
            qualityMenu.classList.remove('show');
            
            // å®é™…è¿›è¡Œåˆ†è¾¨ç‡åˆ‡æ¢
            console.log('ğŸ”„ [å‰ç«¯DEBUG] å¼€å§‹åˆ‡æ¢åˆ†è¾¨ç‡:', quality);
            switchVideoResolution(quality);
            
            showControls();
        }
    });

    // æ’­æ”¾é€Ÿåº¦é€‰æ‹©å™¨æ‰‹åŠ¨æ§åˆ¶
    speedBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('âš¡ ç‚¹å‡»æ’­æ”¾é€Ÿåº¦æŒ‰é’®');
        
        const isOpen = speedMenu.classList.contains('show');
        
        // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå•
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
        
        // åˆ‡æ¢å½“å‰èœå•
        if (!isOpen) {
            speedMenu.classList.add('show');
            console.log('âœ… æ’­æ”¾é€Ÿåº¦èœå•å·²æ‰“å¼€');
        } else {
            speedMenu.classList.remove('show');
            console.log('âŒ æ’­æ”¾é€Ÿåº¦èœå•å·²å…³é—­');
        }
        
        showControls();
    });

    // æ’­æ”¾é€Ÿåº¦é€‰é¡¹ç‚¹å‡»äº‹ä»¶
    speedMenu.addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
            e.preventDefault();
            e.stopPropagation();
            
            const speed = parseFloat(e.target.dataset.speed);
            console.log('âš¡ é€‰æ‹©æ’­æ”¾é€Ÿåº¦:', speed);
            
            // æ›´æ–°æ’­æ”¾é€Ÿåº¦
            if (player) {
                player.playbackRate = speed;
                currentSpeedSpan.textContent = speed + 'x';
                console.log('âœ… æ’­æ”¾é€Ÿåº¦å·²è®¾ç½®ä¸º:', speed);
            }
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            speedMenu.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            e.target.classList.add('active');
            
            // å…³é—­èœå•
            speedMenu.classList.remove('show');
            
            showControls();
        }
    });

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.quality-selector') && !e.target.closest('.playback-speed')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // å¿«é€€æŒ‰é’®äº‹ä»¶
    rewindBtn.addEventListener('click', function() {
        if (player.currentTime > 0) {
            player.currentTime = Math.max(0, player.currentTime - 10);
        }
    });

    // å¿«è¿›æŒ‰é’®äº‹ä»¶
    forwardBtn.addEventListener('click', function() {
        if (player.duration) {
            player.currentTime = Math.min(player.duration, player.currentTime + 10);
        }
    });

    // é™éŸ³æŒ‰é’®äº‹ä»¶
    muteBtn.addEventListener('click', function() {
        player.muted = !player.muted;
        
        if (player.muted) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            muteBtn.title = 'å–æ¶ˆé™éŸ³';
        } else {
            updateMuteButton();
        }
    });

    // éŸ³é‡æ»‘å—äº‹ä»¶
    volumeSlider.addEventListener('input', function() {
        player.volume = this.value;
        player.muted = (this.value === 0);
        updateMuteButton();
    });

    // å…¨å±æŒ‰é’®äº‹ä»¶
    fullscreenBtn.addEventListener('click', toggleFullscreen);

    // ç”»ä¸­ç”»æŒ‰é’®äº‹ä»¶
    pipBtn.addEventListener('click', function() {
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒç”»ä¸­ç”»
        if (document.pictureInPictureElement) {
            document.exitPictureInPicture()
                .then(() => {
                    pipBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                    pipBtn.title = 'ç”»ä¸­ç”»';
                })
                .catch(error => {
                    console.error('é€€å‡ºç”»ä¸­ç”»å¤±è´¥:', error);
                });
        } else if (document.pictureInPictureEnabled) {
            player.requestPictureInPicture()
                .then(() => {
                    pipBtn.innerHTML = '<i class="fas fa-compress-alt"></i>';
                    pipBtn.title = 'é€€å‡ºç”»ä¸­ç”»';
                })
                .catch(error => {
                    console.error('è¿›å…¥ç”»ä¸­ç”»å¤±è´¥:', error);
                });
        } else {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç”»ä¸­ç”»åŠŸèƒ½');
        }
    });

    // æ’­æ”¾é€Ÿåº¦é€‰æ‹©äº‹ä»¶
    speedItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const speed = parseFloat(this.getAttribute('data-speed'));
            player.playbackRate = speed;
            
            // æ›´æ–°å½“å‰é€Ÿåº¦æ˜¾ç¤º
            currentSpeedSpan.textContent = `${speed}x`;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            speedItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // åˆ†è¾¨ç‡é€‰æ‹©ç‚¹å‡»äº‹ä»¶ - å®æ—¶è½¬ç ç‰ˆæœ¬
    function initializeQualitySelection() {
        const qualityItems = qualityMenu.querySelectorAll('.dropdown-item');
        
        qualityItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const quality = this.getAttribute('data-quality');
                console.log('ğŸ¯ [å®æ—¶è½¬ç ] ç”¨æˆ·é€‰æ‹©åˆ†è¾¨ç‡:', quality);
                
                if (quality === currentQuality) {
                    console.log('âš ï¸ [å®æ—¶è½¬ç ] ç›¸åŒåˆ†è¾¨ç‡ï¼Œè·³è¿‡åˆ‡æ¢');
                    qualityMenu.classList.remove('show');
                    return;
                }
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                qualityItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentQualitySpan.textContent = quality;
                currentQuality = quality;
                
                // å…³é—­èœå•
                qualityMenu.classList.remove('show');
                
                // å®é™…è¿›è¡Œåˆ†è¾¨ç‡åˆ‡æ¢ - ä½¿ç”¨å®æ—¶è½¬ç 
                console.log('ğŸš€ [å®æ—¶è½¬ç ] å¼€å§‹åˆ‡æ¢åˆ°:', quality);
                switchVideoResolution(quality);
                
                showControls();
            });
        });
        
        console.log('âœ… [å®æ—¶è½¬ç ] åˆ†è¾¨ç‡é€‰æ‹©å™¨å·²åˆå§‹åŒ–ï¼Œæ”¯æŒåˆ†è¾¨ç‡:', 
            Array.from(qualityItems).map(item => item.getAttribute('data-quality')));
    }
    
    // åŠ¨æ€åŠ è½½å¯ç”¨åˆ†è¾¨ç‡
    function loadAvailableResolutions() {
        console.log('ğŸ” [å®æ—¶è½¬ç ] æ­£åœ¨è·å–å¯ç”¨åˆ†è¾¨ç‡...');
        
        fetch(`/api/{{ movie.pk }}/resolutions/`)
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“Š [å®æ—¶è½¬ç ] APIå“åº”:', data);
                
                if (data.success && data.resolutions) {
                    const resolutions = data.resolutions;
                    console.log('âœ… [å®æ—¶è½¬ç ] å¯ç”¨åˆ†è¾¨ç‡:', resolutions);
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    qualityMenu.innerHTML = '';
                    
                    // æ·»åŠ åˆ†è¾¨ç‡é€‰é¡¹
                    resolutions.forEach((resolution, index) => {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.href = '#';
                        item.setAttribute('data-quality', resolution);
                        item.textContent = resolution;
                        
                        // ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼ˆåŸç”»ï¼‰è®¾ä¸ºæ´»åŠ¨çŠ¶æ€
                        if (index === 0) {
                            item.classList.add('active');
                        }
                        
                        qualityMenu.appendChild(item);
                    });
                    
                    // é‡æ–°åˆå§‹åŒ–ç‚¹å‡»äº‹ä»¶
                    initializeQualitySelection();
                    
                    console.log('ğŸ¯ [å®æ—¶è½¬ç ] åˆ†è¾¨ç‡èœå•å·²æ›´æ–°');
                } else {
                    console.error('âŒ [å®æ—¶è½¬ç ] è·å–åˆ†è¾¨ç‡å¤±è´¥:', data.error);
                    // ä½¿ç”¨é»˜è®¤åˆ†è¾¨ç‡
                    qualityMenu.innerHTML = `
                        <a class="dropdown-item active" data-quality="åŸç”»" href="#">åŸç”»</a>
                        <a class="dropdown-item" data-quality="720p" href="#">720p</a>
                        <a class="dropdown-item" data-quality="480p" href="#">480p</a>
                        <a class="dropdown-item" data-quality="360p" href="#">360p</a>
                    `;
                    initializeQualitySelection();
                }
            })
            .catch(error => {
                console.error('âŒ [å®æ—¶è½¬ç ] ç½‘ç»œé”™è¯¯:', error);
                // ä½¿ç”¨é»˜è®¤åˆ†è¾¨ç‡
                qualityMenu.innerHTML = `
                    <a class="dropdown-item active" data-quality="åŸç”»" href="#">åŸç”»</a>
                    <a class="dropdown-item" data-quality="720p" href="#">720p</a>
                    <a class="dropdown-item" data-quality="480p" href="#">480p</a>
                    <a class="dropdown-item" data-quality="360p" href="#">360p</a>
                `;
                initializeQualitySelection();
            });
    }
    
    // åŠ è½½å¯ç”¨åˆ†è¾¨ç‡
    loadAvailableResolutions();

    // æ—§çš„é¢„è½¬ç ä»£ç å·²æ¸…ç†ï¼Œä½¿ç”¨å®æ—¶è½¬ç 

    // åˆå§‹åŒ–
    initializePlayerState();
    showControls();
    
    // å°è¯•åŠ è½½å¯ç”¨åˆ†è¾¨ç‡
    loadAvailableResolutions();
});
</script>
{% endblock %} 