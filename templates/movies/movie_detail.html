{% extends 'base.html' %}

{% block title %}{{ movie.title }} - 个人影视网站{% endblock %}

{% block extra_css %}
<!-- FontAwesome图标库 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Bootstrap Icons作为备用 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<!-- HLS.js for better HLS support -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>

<style>
    /* 实时转码相关样式 */
    .transcoding-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    }
    
    .transcoding-indicator.error {
        background-color: rgba(200, 0, 0, 0.7);
    }
    
    .transcoding-spinner {
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .transcoding-text {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
    }
    
    /* 实时转码指示器样式 */
    .realtime-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(76, 175, 80, 0.8);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        z-index: 900;
        transition: opacity 0.5s ease;
    }
    
    .realtime-icon {
        margin-right: 8px;
        color: yellow;
        font-size: 14px;
    }
    
    .realtime-text {
        font-size: 14px;
        font-weight: bold;
    }
    
    /* 分辨率按钮样式 */
    .quality-button {
        position: relative;
    }
    
    .quality-menu {
        position: absolute;
        bottom: 45px;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        padding: 8px 0;
        min-width: 120px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        z-index: 110;
    }
    
    .quality-menu.active {
        display: flex;
    }
    
    .quality-option {
        padding: 8px 15px;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s ease;
        white-space: nowrap;
        text-align: left;
    }
    
    .quality-option:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .quality-option.selected {
        color: #007bff;
        font-weight: bold;
    }
    
    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        max-width: 100%;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .video-container:hover {
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
    }
    
    .video-player {
        width: 100%;
        height: auto;
        max-height: 70vh;
        background: #000;
    }
    
    /* 完全隐藏浏览器默认控制栏 */
    .video-player::-webkit-media-controls {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-enclosure {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-panel {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-play-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-timeline {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-current-time-display {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-time-remaining-display {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-mute-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-toggle-closed-captions-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-volume-slider {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-fullscreen-button {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-overlay-enclosure {
        display: none !important;
    }
    
    .video-player::-webkit-media-controls-overlay-play-button {
        display: none !important;
    }

    /* 自定义播放器控制栏 */
    .custom-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        padding: 15px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
    }
    
    /* 控制栏显示逻辑 - 普通模式 */
    .video-container:hover .custom-controls,
    .video-container.controls-visible .custom-controls,
    .video-container.paused .custom-controls {
        opacity: 1;
        pointer-events: auto;
    }
    
    /* 全屏模式下控制栏的强制隐藏 - 最高优先级 */
    .video-container:fullscreen .custom-controls,
    .video-container:-webkit-full-screen .custom-controls,
    .video-container:-moz-full-screen .custom-controls {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 9999 !important;
        background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.5) 60%, transparent 100%) !important;
        backdrop-filter: blur(10px) !important;
        -webkit-backdrop-filter: blur(10px) !important;
        padding: 20px 20px 25px 20px !important;
        transition: opacity 0.3s ease, transform 0.3s ease !important;
        
        /* 默认隐藏状态 */
        opacity: 0 !important;
        transform: translateY(100%) !important;
        pointer-events: none !important;
        visibility: hidden !important;
    }
    
    /* 全屏模式显示控制栏的条件 - 超高优先级 */
    .video-container:fullscreen:hover .custom-controls,
    .video-container:-webkit-full-screen:hover .custom-controls,
    .video-container:-moz-full-screen:hover .custom-controls {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
    }
    
    .video-container:fullscreen.controls-visible .custom-controls,
    .video-container:-webkit-full-screen.controls-visible .custom-controls,
    .video-container:-moz-full-screen.controls-visible .custom-controls {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
    }
    
    .video-container:fullscreen.paused .custom-controls,
    .video-container:-webkit-full-screen.paused .custom-controls,
    .video-container:-moz-full-screen.paused .custom-controls {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
    }
    
    /* 进度条容器 */
    .progress-container {
        padding: 0 5px;
        position: relative;
        margin-bottom: 10px;
    }
    
    .progress-bar-custom {
        position: relative;
        width: 100%;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
        cursor: pointer;
        transition: height 0.2s ease, transform 0.1s ease;
    }
    
    .progress-bar-custom:hover {
        height: 6px;
        transform: scaleY(1.2);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #00c6ff);
        border-radius: 2px;
        width: 0%;
        position: relative;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    }
    
    .progress-thumb {
        position: absolute;
        right: -8px;
        top: 50%;
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transform: translateY(-50%) scale(0);
        transition: transform 0.2s ease;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 10;
    }
    
    .progress-bar-custom:hover .progress-thumb {
        transform: translateY(-50%) scale(1);
    }
    
    /* 控制按钮行 */
    .controls-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: white;
    }
    
    .controls-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .controls-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .control-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 2px;
    }
    
    .control-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: scale(1.1);
        color: #fff;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .control-btn:active {
        transform: scale(0.95);
    }
    
    .time-display {
        font-size: 14px;
        font-family: 'Courier New', monospace;
        margin-left: 10px;
        background: rgba(0,0,0,0.5);
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
        color: #fff;
        font-weight: 500;
    }
    
    .volume-container {
        display: flex;
        align-items: center;
        background: rgba(0,0,0,0.5);
        border-radius: 20px;
        padding: 3px 10px;
        transition: all 0.3s ease;
        overflow: hidden;
        width: auto;
    }
    
    .volume-container:hover {
        background: rgba(0,0,0,0.7);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }
    
    .volume-slider {
        width: 0;
        height: 4px;
        background: rgba(255,255,255,0.3);
        border-radius: 2px;
        outline: none;
        cursor: pointer;
        transition: width 0.3s ease, opacity 0.3s ease;
        opacity: 0;
        margin-left: 0;
    }
    
    .volume-container:hover .volume-slider {
        width: 70px;
        opacity: 1;
        margin-left: 8px;
    }
    
    /* 下拉菜单统一样式 - 清理版本 */
    .playback-speed,
    .quality-selector {
        position: relative;
        margin-right: 10px;
    }
    
    /* 清晰度标签 */
    .quality-label {
        background: linear-gradient(135deg, #0062cc, #0097ff);
        color: white;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
        display: inline-block;
        vertical-align: middle;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    }
    
    .quality-label .current-quality {
        color: white;
        font-weight: 500;
    }
    
    /* 播放速度显示 */
    .current-speed {
        font-size: 10px;
        margin-left: 3px;
        color: white;
        font-weight: 500;
    }
    
    /* 全屏模式 */
    .video-container:fullscreen {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100vw !important;
        height: 100vh !important;
    }
    
    .video-container:-webkit-full-screen {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100vw !important;
        height: 100vh !important;
    }
    
    .video-container:-moz-full-screen {
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100vw !important;
        height: 100vh !important;
    }
    
    /* 全屏时视频样式 */
    .video-container:fullscreen .video-player {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        object-fit: contain;
    }
    
    .video-container:-webkit-full-screen .video-player {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        object-fit: contain;
    }
    
    .video-container:-moz-full-screen .video-player {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        object-fit: contain;
    }
    
    /* 全屏提示样式 */
    .fullscreen-hint {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 1001;
        backdrop-filter: blur(5px);
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    
    /* 加载指示器 */
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
    }
    
    /* 转码指示器 */
    .transcoding-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        max-width: 400px;
        text-align: center;
    }
    
    /* 播放器控制栏下拉菜单样式 */
    .custom-controls .dropdown-menu {
        background: rgba(0, 0, 0, 0.95) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        border-radius: 10px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8) !important;
        padding: 8px 0 !important;
        margin: 0 !important;
        display: none !important;
        position: absolute !important;
        top: auto !important;
        bottom: 50px !important;
        right: 0 !important;
        left: auto !important;
        z-index: 9999 !important;
        min-width: 120px !important;
        overflow: hidden !important;
    }
    
    .custom-controls .dropdown-menu.show {
        display: block !important;
    }
    
    .custom-controls .dropdown-item {
        color: rgba(255, 255, 255, 0.9) !important;
        background: transparent !important;
        border: none !important;
        padding: 10px 16px !important;
        margin: 0 !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        transition: all 0.2s ease !important;
        text-decoration: none !important;
        display: block !important;
        width: 100% !important;
        text-align: left !important;
        white-space: nowrap !important;
        border-radius: 0 !important;
    }
    
    .custom-controls .dropdown-item:hover,
    .custom-controls .dropdown-item:focus {
        background: rgba(255, 255, 255, 0.15) !important;
        color: rgba(255, 255, 255, 1) !important;
        box-shadow: none !important;
        outline: none !important;
        transform: translateX(2px) !important;
    }
    
    .custom-controls .dropdown-item.active {
        background: rgba(0, 123, 255, 0.25) !important;
        color: rgba(255, 255, 255, 1) !important;
        position: relative !important;
    }
    
    .custom-controls .dropdown-item.active::after {
        content: '✓' !important;
        position: absolute !important;
        right: 12px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        color: #00d4ff !important;
        font-weight: bold !important;
        font-size: 12px !important;
    }
    
    .custom-controls .dropdown-toggle {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
    }
    
    .custom-controls .dropdown-toggle:focus {
        box-shadow: none !important;
        outline: none !important;
    }
    
    .custom-controls .dropdown-toggle::after {
        display: none !important;
    }
    
    /* 移动端优化 */
    @media (max-width: 768px) {
        .controls-left, .controls-right {
            gap: 8px;
        }
        
        .control-btn {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
        
        .time-display {
            font-size: 12px;
            padding: 3px 6px;
        }
        
        .quality-label {
            font-size: 10px;
            padding: 1px 4px;
        }
        
        .current-speed {
            font-size: 9px;
        }
        
        /* 移动端下拉菜单优化 */
        .custom-controls .dropdown-menu {
            min-width: 100px !important;
            font-size: 12px !important;
        }
        
        .custom-controls .dropdown-item {
            padding: 6px 12px !important;
            font-size: 12px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <!-- 视频播放区域 -->
        <div class="col-lg-8">
            <!-- 快捷键提示 -->
            <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="mb-2"><i class="fas fa-keyboard"></i> 键盘快捷键</h6>
                        <small>
                            <strong>空格:</strong> 播放/暂停 &nbsp; 
                            <strong>F:</strong> 全屏 &nbsp; 
                            <strong>M:</strong> 静音 &nbsp; 
                            <strong>Esc:</strong> 退出全屏
                        </small>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-2"><i class="fas fa-arrows-alt"></i> 方向键</h6>
                        <small>
                            <strong>←/→:</strong> 快退/快进10秒 &nbsp; 
                            <strong>↑/↓:</strong> 调节音量 &nbsp; 
                            <strong>双击:</strong> 全屏
                        </small>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-2"><i class="fas fa-expand"></i> 沉浸式全屏</h6>
                        <small>
                            <strong>自动隐藏:</strong> 控制栏2秒后隐藏 &nbsp; 
                            <strong>鼠标唤醒:</strong> 移动鼠标显示 &nbsp; 
                            <strong>点击唤醒:</strong> 单击屏幕显示
                        </small>
                    </div>
                </div>
            </div>

            <!-- 视频播放器 -->
            <div class="video-container mb-4" id="videoContainer">
                <video class="video-player" id="moviePlayer" preload="metadata" poster="{% if movie.thumbnail %}{{ movie.thumbnail.url }}{% endif %}">
                    <source src="{% url 'serve_video' movie.pk %}" type="video/mp4">
                    您的浏览器不支持HTML5视频播放。
                </video>
                
                <!-- 自定义控制栏 -->
                <div class="custom-controls" id="customControls">
                    <div class="progress-container">
                        <div class="progress-bar-custom" id="progressBar">
                            <div class="progress-fill" id="progressFill">
                                <div class="progress-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div class="controls-row">
                        <div class="controls-left">
                            <button class="control-btn play-pause-btn" id="playPauseBtn" title="播放">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="control-btn rewind-btn" id="rewindBtn" title="快退10秒">
                                <i class="fas fa-undo-alt"></i>
                            </button>
                            <button class="control-btn forward-btn" id="forwardBtn" title="快进10秒">
                                <i class="fas fa-redo-alt"></i>
                            </button>
                            <div class="volume-container">
                                <button class="control-btn mute-btn" id="muteBtn" title="静音">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                            </div>
                            <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
                        </div>
                        <div class="controls-right">
                            <!-- 播放速度控制 -->
                            <div class="playback-speed dropdown">
                                <button class="control-btn" id="speedBtn" title="播放速度">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span class="current-speed" id="currentSpeed">1.0x</span>
                                </button>
                                <div class="dropdown-menu playback-speed-menu dropdown-menu-end" id="speedMenu">
                                    <a class="dropdown-item" data-speed="0.5" href="#">0.5x</a>
                                    <a class="dropdown-item" data-speed="0.75" href="#">0.75x</a>
                                    <a class="dropdown-item active" data-speed="1.0" href="#">1.0x</a>
                                    <a class="dropdown-item" data-speed="1.25" href="#">1.25x</a>
                                    <a class="dropdown-item" data-speed="1.5" href="#">1.5x</a>
                                    <a class="dropdown-item" data-speed="2.0" href="#">2.0x</a>
                                </div>
                            </div>
                            
                            <!-- 画中画按钮 -->
                            <button class="control-btn pip-btn" id="pipBtn" title="画中画">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            
                            <!-- 清晰度选择 - 手动控制版本 -->
                            <div class="quality-selector dropdown">
                                <button class="control-btn" id="qualityBtn" title="清晰度">
                                    <i class="fas fa-cog"></i>
                                    <span class="quality-label">
                                        <span class="current-quality" id="currentQuality">原画</span>
                                    </span>
                                </button>
                                <div class="dropdown-menu quality-menu dropdown-menu-end" id="qualityMenu">
                                    <!-- 分辨率选项将通过JavaScript动态加载 -->
                                </div>
                            </div>
                            
                            <!-- 全屏按钮 -->
                            <button class="control-btn fullscreen-btn" id="fullscreenBtn" title="全屏">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 加载指示器 -->
                <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
                
                <!-- 全屏提示 -->
                <div class="fullscreen-hint" id="fullscreenHint" style="opacity: 0;">
                    <i class="fas fa-keyboard"></i> 按 <b>F</b> 可退出全屏
                </div>
                
                <!-- 转码指示器 -->
                <div class="transcoding-indicator" id="transcodingIndicator" style="display: none;">
                    <div class="card bg-dark text-white p-3">
                        <h5><i class="fas fa-cog fa-spin"></i> 正在处理视频</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="transcodingProgress" style="width: 100%"></div>
                        </div>
                        <p class="transcoding-status" id="transcodingStatus">正在转码为720p...</p>
                        <p class="transcoding-time" id="transcodingTime">转码时间: 0秒</p>
                        <small class="text-muted">首次转码需要等待，稍后观看将直接播放</small>
                    </div>
                </div>
            </div>
            
            <!-- 影片信息 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">{{ movie.title }}</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>文件名：</strong> {{ movie.file_name }}</p>
                            <p><strong>文件大小：</strong> {{ movie.file_size_mb }} MB</p>
                            {% if movie.duration %}
                            <p><strong>时长：</strong> {{ movie.duration }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if movie.genre %}
                            <p><strong>类型：</strong> 
                                <span class="badge bg-secondary">{{ movie.genre }}</span>
                            </p>
                            {% endif %}
                            {% if movie.year %}
                            <p><strong>年份：</strong> {{ movie.year }}</p>
                            {% endif %}
                            <p><strong>观看次数：</strong> {{ movie.views }}</p>
                        </div>
                    </div>
                    
                    {% if movie.description %}
                    <div class="mb-3">
                        <h5>简介</h5>
                        <p>{{ movie.description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if avg_rating %}
                    <div class="mb-3">
                        <h5>平均评分</h5>
                        <div class="rating-stars">
                            {% for i in "12345" %}
                            {% if forloop.counter <= avg_rating %}
                            <i class="bi bi-star-fill"></i>
                            {% else %}
                            <i class="bi bi-star"></i>
                            {% endif %}
                            {% endfor %}
                            <span class="ms-2">{{ avg_rating|floatformat:1 }}/5.0</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 侧边栏 -->
        <div class="col-lg-4">
            {% if user.is_authenticated %}
            <!-- 评分表单 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-star"></i> 为这部影片评分
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'rate_movie' movie.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ rating_form.rating.label_tag }}
                            {{ rating_form.rating }}
                        </div>
                        <div class="mb-3">
                            {{ rating_form.comment.label_tag }}
                            {{ rating_form.comment }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-send"></i> 提交评分
                        </button>
                    </form>
                    
                    {% if user_rating %}
                    <hr>
                    <div class="alert alert-info">
                        <strong>您的评分：</strong>
                        <div class="rating-stars">
                            {% for i in "12345" %}
                            {% if forloop.counter <= user_rating.rating %}
                            <i class="bi bi-star-fill"></i>
                            {% else %}
                            <i class="bi bi-star"></i>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% if user_rating.comment %}
                        <p class="mt-2 mb-0">{{ user_rating.comment }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 观看进度 -->
            {% if watch_history and watch_history.progress %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> 观看进度
                    </h5>
                </div>
                <div class="card-body">
                    <p>上次观看到：{{ watch_history.progress }}</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="resumeFromProgress()">
                        <i class="bi bi-play"></i> 继续观看
                    </button>
                </div>
            </div>
            {% endif %}
            {% else %}
            <!-- 登录提示 -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5>登录后可以</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-star text-warning"></i> 评分和评论</li>
                        <li><i class="bi bi-clock-history text-info"></i> 保存观看进度</li>
                        <li><i class="bi bi-heart text-danger"></i> 收藏影片</li>
                    </ul>
                    <a href="{% url 'login' %}" class="btn btn-primary">立即登录</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 评论区域 -->
    {% if ratings %}
    <div class="row mt-4">
        <div class="col-12">
            <h4>用户评论</h4>
            {% for rating in ratings %}
            <div class="comment-card card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">{{ rating.user.username }}</h6>
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                {% if forloop.counter <= rating.rating %}
                                <i class="bi bi-star-fill"></i>
                                {% else %}
                                <i class="bi bi-star"></i>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <small class="text-muted">{{ rating.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    {% if rating.comment %}
                    <p class="card-text mt-2">{{ rating.comment }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 获取元素引用
    const player = document.getElementById('moviePlayer');
    const videoContainer = document.getElementById('videoContainer');
    const customControls = document.getElementById('customControls');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const timeDisplay = document.getElementById('timeDisplay');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const pipBtn = document.getElementById('pipBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const qualityBtn = document.getElementById('qualityBtn');
    const qualityMenu = document.getElementById('qualityMenu');
    const currentQualitySpan = document.getElementById('currentQuality');
    const speedMenu = document.getElementById('speedMenu');
    const speedBtn = document.getElementById('speedBtn');
    const currentSpeedSpan = document.getElementById('currentSpeed');
    const speedItems = document.querySelectorAll('#speedMenu .dropdown-item');
    const transcodingIndicator = document.getElementById('transcodingIndicator');
    const transcodingStatus = document.getElementById('transcodingStatus');
    const transcodingProgress = document.getElementById('transcodingProgress');
    const transcodingTime = document.getElementById('transcodingTime');
    const fullscreenHint = document.getElementById('fullscreenHint');

    // 状态变量
    let progressUpdateInterval;
    let controlsTimeout;
    let isTogglingPlayPause = false;
    let isDragging = false;
    let isFullscreen = false;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let currentTranscodeId = null;
    let transcodingInterval = null;
    let currentQuality = "原画";
    let controlsVisible = false;

    // 初始化播放器状态
    function initializePlayerState() {
        // 完全禁用浏览器默认控制栏
        player.controls = false;
        player.disablePictureInPicture = false;
        
        // 确保播放/暂停按钮状态正确
        if (player.paused) {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.title = '播放';
        } else {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.title = '暂停';
        }
        
        // 设置音量滑块
        volumeSlider.value = player.volume;
        
        // 设置静音按钮状态
        updateMuteButton();
        
        console.log('🔧 播放器状态已初始化');
    }

    // 显示控制栏 - 修复版本
    function showControls() {
        if (controlsTimeout) {
            clearTimeout(controlsTimeout);
        }
        
        //console.log('🎮 显示控制栏，全屏状态:', isFullscreen, '暂停状态:', player.paused);
        
        controlsVisible = true;
        videoContainer.classList.add('controls-visible');
        
        // 只有在视频真正暂停时才添加paused类
        if (player.paused) {
            videoContainer.classList.add('paused');
        }
        
        videoContainer.style.cursor = 'default';
        
        // 如果视频正在播放，设置自动隐藏
        if (player && !player.paused && !isMouseOverControls()) {
            controlsTimeout = setTimeout(() => {
                hideControls();
            }, 3000);
        }
    }

    // 隐藏控制栏 - 修复版本
    function hideControls() {
        console.log('🙈 尝试隐藏控制栏，全屏状态:', isFullscreen, '暂停状态:', player.paused, '鼠标在控制栏上:', isMouseOverControls());
        
        // 如果视频暂停或鼠标在控制栏上，不隐藏
        if (player.paused || isMouseOverControls()) {
            console.log('🚫 控制栏隐藏被阻止');
            return;
        }
        
        controlsVisible = false;
        videoContainer.classList.remove('controls-visible');
        
        // 移除paused类，确保全屏时能隐藏
        if (!player.paused) {
            videoContainer.classList.remove('paused');
        }
        
        // 全屏模式下隐藏鼠标指针
        if (isFullscreen) {
            videoContainer.style.cursor = 'none';
            console.log('🖱️ 全屏模式：隐藏鼠标指针');
        }
        
        console.log('✅ 控制栏已隐藏');
    }
    
    // 检查鼠标是否在控制栏上
    function isMouseOverControls() {
        return document.querySelector('.custom-controls:hover') !== null ||
               document.querySelector('.dropdown-menu.show') !== null;
    }

    // 切换全屏模式
    function toggleFullscreen() {
        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
            // 退出全屏
            console.log('🔙 退出全屏模式');
            
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = '全屏';
            
            // 恢复普通模式样式
            videoContainer.style.cursor = 'default';
            if (player.paused) {
                showControls();
            } else {
                hideControls();
            }
            
        } else {
            // 进入全屏
            console.log('🔍 进入全屏模式');
            
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            } else if (videoContainer.webkitRequestFullscreen) {
                videoContainer.webkitRequestFullscreen();
            } else if (videoContainer.mozRequestFullScreen) {
                videoContainer.mozRequestFullScreen();
            }
            
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = '退出全屏';
            
            // 显示全屏提示
            fullscreenHint.style.opacity = '1';
            setTimeout(() => {
                fullscreenHint.style.opacity = '0';
            }, 3000);
            
            // 短暂显示控制栏后隐藏
            showControls();
            setTimeout(() => {
                if (!player.paused) {
                    console.log('⏰ 3秒后自动隐藏控制栏');
                    hideControls();
                }
            }, 3000);
        }
    }

    // 更新进度条
    function updateProgress() {
        if (player.duration) {
            const progress = (player.currentTime / player.duration) * 100;
            progressFill.style.width = `${progress}%`;
            
            // 更新时间显示
            updateTimeDisplay();
            
            // 检查是否已看完，如需记录观看进度
            if (progress > 95) {
                console.log('视频已看完');
                // 可以添加发送观看完成记录的逻辑
            }
        }
    }

    // 更新时间显示
    function updateTimeDisplay() {
        const currentTime = formatTime(player.currentTime);
        const duration = formatTime(player.duration);
        timeDisplay.textContent = `${currentTime} / ${duration}`;
    }

    // 时间格式化
    function formatTime(seconds) {
        if (isNaN(seconds) || !isFinite(seconds)) {
            return '00:00';
        }
        
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // 更新静音按钮状态
    function updateMuteButton() {
        if (player.muted || player.volume === 0) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            muteBtn.title = '取消静音';
        } else if (player.volume < 0.5) {
            muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
            muteBtn.title = '静音';
        } else {
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            muteBtn.title = '静音';
        }
    }

    // 从鼠标位置更新进度条
    function updateProgressFromMouse(e) {
        const rect = progressBar.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const progress = Math.max(0, Math.min(1, clickX / rect.width));
        
        // 检查视频是否已加载足够的数据
        if (player.duration && player.readyState >= 2) {
            player.currentTime = progress * player.duration;
            updateProgress();
        }
    }

    // 测试API连接
    function testApiConnection() {
        console.log('🔍 [前端DEBUG] 测试API连接...');
        
        fetch('/api/test/')
            .then(response => {
                console.log('📡 [前端DEBUG] 测试API响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('✅ [前端DEBUG] 测试API响应:', data);
            })
            .catch(error => {
                console.error('❌ [前端DEBUG] 测试API失败:', error);
            });
    }

    // 加载可用的分辨率选项
    function loadAvailableResolutions() {
        console.log('🔍 [前端DEBUG] 检测可用分辨率...');
        console.log('🔗 [前端DEBUG] 请求URL:', `/api/{{ movie.pk }}/resolutions/`);
        
        // 先测试API连接
        testApiConnection();
        
        fetch(`/api/{{ movie.pk }}/resolutions/`)
            .then(response => {
                console.log('📡 [前端DEBUG] 分辨率API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ [前端DEBUG] 分辨率API响应成功:', data);
                
                if (data.success && data.resolutions.length > 0) {
                    console.log('✅ [前端DEBUG] 获取可用分辨率成功:', data.resolutions);
                    console.log('📺 [前端DEBUG] 原始视频信息:', data.original_info);
                    
                    // 显示所有可用分辨率
                    const items = qualityMenu.querySelectorAll('.dropdown-item');
                    items.forEach(item => {
                        const quality = item.dataset.quality;
                        if (quality === '原画' || data.resolutions.includes(quality)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                } else {
                    console.log('⚠️ [前端DEBUG] 没有可用的转码选项，使用原画播放');
                }
            })
            .catch(error => {
                console.error('❌ [前端DEBUG] 获取可用分辨率失败:', error);
                console.error('❌ [前端DEBUG] 详细错误信息:', error.message);
            });
    }

    // 分辨率切换函数
    function switchVideoResolution(resolution) {
        console.log('🔄 [前端DEBUG] 切换分辨率到:', resolution);
        
        // 保存当前播放状态
        const currentTime = player.currentTime;
        const wasPlaying = !player.paused;
        
        if (resolution === '原画') {
            // 切换回原画
            console.log('📺 [前端DEBUG] 切换到原画质量');
            player.src = "{% url 'serve_video' movie.pk %}";
            player.currentTime = currentTime;
            if (wasPlaying) {
                player.play();
            }
        } else {
            // 请求实时转码
            console.log('🚀 [前端DEBUG] 请求实时转码:', resolution);
            requestRealtimeTranscode(resolution, currentTime, wasPlaying);
        }
    }

    // 请求实时转码
    function requestRealtimeTranscode(resolution, currentTime, wasPlaying) {
        console.log('🔥 [前端DEBUG] 开始实时转码请求:', resolution);
        
        // 显示转码提示
        showTranscodingIndicator();
        updateTranscodingStatus(`正在准备 ${resolution} 实时转码...`);
        
        const apiUrl = `/api/{{ movie.pk }}/realtime/${resolution}/`;
        console.log('🔗 [前端DEBUG] 转码API URL:', apiUrl);
        
        fetch(apiUrl)
            .then(response => {
                console.log('📡 [前端DEBUG] 转码API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📡 [前端DEBUG] 转码API响应:', data);
                
                if (data.success) {
                    if (data.realtime) {
                        console.log('✅ [前端DEBUG] 实时转码会话创建成功:', data.session_id);
                        
                        // 保存会话ID
                        window.realtimeSessionId = data.session_id;
                        
                        // 更新状态显示
                        if (data.rtx_optimized) {
                            updateTranscodingStatus(`RTX 3070 正在实时转码 ${resolution}...`);
                        } else {
                            updateTranscodingStatus(`正在实时转码 ${resolution}...`);
                        }
                        
                        // 等待几秒后检查HLS流
                        setTimeout(() => {
                            loadRealtimeHLS(resolution, data.session_id, currentTime, wasPlaying);
                        }, 3000);
                        
                    } else {
                        // 原画不需要转码
                        hideTranscodingIndicator();
                        console.log('📺 [前端DEBUG] 原画质量，无需转码');
                    }
                } else {
                    hideTranscodingIndicator();
                    console.error('❌ [前端DEBUG] 转码请求失败:', data.error);
                    alert(`转码请求失败: ${data.error}`);
                }
            })
            .catch(error => {
                hideTranscodingIndicator();
                console.error('❌ [前端DEBUG] 转码请求网络错误:', error);
                console.error('❌ [前端DEBUG] 错误详情:', error.message);
                alert('转码请求失败，请检查网络连接');
            });
    }

    // 加载实时HLS流 - 修复版本
    function loadRealtimeHLS(resolution, sessionId, currentTime, wasPlaying) {
        console.log('📺 [实时转码] 开始加载HLS流:', resolution, sessionId);
        
        let retryCount = 0;
        const maxRetries = 15; // 最多重试15次 (约30秒)
        
        function attemptLoad() {
            console.log(`🔄 [实时转码] 尝试加载HLS流 (${retryCount + 1}/${maxRetries})`);
            
            fetch(`/api/{{ movie.pk }}/realtime/${resolution}/${sessionId}/`)
                .then(response => {
                    console.log('📡 [实时转码] HLS API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('🎞️ [实时转码] HLS流响应:', data);
                    
                    if (data.success && data.hls_url) {
                        console.log('✅ [实时转码] HLS流准备就绪，URL:', data.hls_url);
                        
                        // 使用HLS.js库来处理HLS流
                        if (window.Hls && Hls.isSupported()) {
                            // 使用HLS.js
                            if (window.hlsInstance) {
                                window.hlsInstance.destroy();
                            }
                            
                            window.hlsInstance = new Hls({
                                debug: false,
                                enableWorker: true,
                                liveSyncDurationCount: 3,
                                liveMaxLatencyDurationCount: 5,
                                manifestLoadingTimeOut: 10000,
                                manifestLoadingMaxRetry: 4,
                                levelLoadingTimeOut: 10000,
                                fragLoadingTimeOut: 20000
                            });
                            
                            // 直接加载HLS URL
                            window.hlsInstance.loadSource(data.hls_url);
                            window.hlsInstance.attachMedia(player);
                            
                            window.hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                console.log('🎯 [实时转码] HLS清单解析完成');
                                player.currentTime = currentTime;
                                
                                if (wasPlaying) {
                                    player.play().then(() => {
                                        console.log('▶️ [实时转码] 开始播放HLS流');
                                    }).catch(error => {
                                        console.error('❌ [实时转码] 播放失败:', error);
                                    });
                                }
                                
                                hideTranscodingIndicator();
                                showRealtimeIndicator(resolution);
                                console.log('🎉 [实时转码] 播放成功!');
                            });
                            
                            window.hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                                console.error('❌ [实时转码] HLS错误:', data);
                                if (data.fatal) {
                                    hideTranscodingIndicator();
                                    alert('视频流播放失败，请重试');
                                }
                            });
                            
                        } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                            // 原生支持HLS (Safari)
                            console.log('🍎 [实时转码] 使用原生HLS支持');
                            
                            player.src = data.hls_url;
                            player.currentTime = currentTime;
                            
                            if (wasPlaying) {
                                player.play();
                            }
                            
                            hideTranscodingIndicator();
                            showRealtimeIndicator(resolution);
                            console.log('🎉 [实时转码] 原生HLS播放成功!');
                        } else {
                            console.error('❌ [实时转码] 浏览器不支持HLS播放');
                            hideTranscodingIndicator();
                            alert('您的浏览器不支持HLS视频流播放');
                        }
                        
                    } else {
                        console.warn(`⚠️ [实时转码] HLS流未准备好 (${retryCount + 1}/${maxRetries})`);
                        updateTranscodingStatus(`${resolution} 转码进行中... (${retryCount + 1}/${maxRetries})`);
                        
                        retryCount++;
                        if (retryCount < maxRetries) {
                            // 2秒后重试
                            setTimeout(attemptLoad, 2000);
                        } else {
                            console.error('❌ [实时转码] 达到最大重试次数');
                            hideTranscodingIndicator();
                            alert('转码超时，请稍后重试或选择其他分辨率');
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ [实时转码] 网络错误:', error);
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.log(`🔄 [实时转码] 网络错误，2秒后重试 (${retryCount}/${maxRetries})`);
                        updateTranscodingStatus(`网络错误，正在重试... (${retryCount}/${maxRetries})`);
                        setTimeout(attemptLoad, 2000);
                    } else {
                        hideTranscodingIndicator();
                        alert('网络连接失败，请检查网络后重试');
                    }
                });
        }
        
        // 开始首次尝试
        attemptLoad();
    }

    // 显示转码指示器
    function showTranscodingIndicator() {
        const indicator = document.getElementById('transcodingIndicator');
        if (indicator) {
            indicator.style.display = 'block';
        }
    }

    // 隐藏转码指示器
    function hideTranscodingIndicator() {
        const indicator = document.getElementById('transcodingIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    // 更新转码状态
    function updateTranscodingStatus(message) {
        const statusElement = document.getElementById('transcodingStatus');
        if (statusElement) {
            statusElement.textContent = message;
        }
    }

    // 事件监听器
    // =============
    
    // 移动鼠标时显示控制栏
    videoContainer.addEventListener('mousemove', function(e) {
        //console.log('🖱️ 鼠标移动，全屏状态:', isFullscreen);
        showControls();
    });
    
    videoContainer.addEventListener('click', function(e) {
        // 如果点击的不是控制按钮，则切换播放/暂停
        if (!e.target.closest('.custom-controls')) {
            playPauseBtn.click();
        }
        showControls();
    });

    // 鼠标离开视频区域时的处理
    videoContainer.addEventListener('mouseleave', function() {
        if (isFullscreen && !player.paused) {
            //console.log('🖱️ 鼠标离开全屏区域，2秒后隐藏控制栏');
            setTimeout(() => {
                if (isFullscreen && !player.paused && !isMouseOverControls()) {
                    hideControls();
                }
            }, 2000);
        }
    });

    // 键盘快捷键 - 修复版本
    document.addEventListener('keydown', function(e) {
        // 避免在输入框中触发快捷键
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }

        // 确保播放器已加载
        if (!player) return;

        switch(e.code) {
            case 'Space':
                e.preventDefault();
                if (playPauseBtn) {
                    playPauseBtn.click();
                }
                showControls();
                break;
            case 'KeyF':
                e.preventDefault();
                toggleFullscreen();
                break;
            case 'KeyM':
                e.preventDefault();
                if (muteBtn) {
                    muteBtn.click();
                }
                showControls();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                if (rewindBtn) {
                    rewindBtn.click();
                }
                showControls();
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (forwardBtn) {
                    forwardBtn.click();
                }
                showControls();
                break;
            case 'ArrowUp':
                e.preventDefault();
                if (player.volume !== undefined) {
                    player.volume = Math.min(1, player.volume + 0.1);
                    if (volumeSlider) volumeSlider.value = player.volume;
                    updateMuteButton();
                }
                showControls();
                break;
            case 'ArrowDown':
                e.preventDefault();
                if (player.volume !== undefined) {
                    player.volume = Math.max(0, player.volume - 0.1);
                    if (volumeSlider) volumeSlider.value = player.volume;
                    updateMuteButton();
                }
                showControls();
                break;
            case 'Escape':
                if (isFullscreen) {
                    toggleFullscreen();
                }
                break;
        }
    });

    // 双击全屏
    player.addEventListener('dblclick', function() {
        toggleFullscreen();
    });

    // 监听全屏状态变化
    document.addEventListener('fullscreenchange', function() {
        if (!document.fullscreenElement) {
            console.log('🔄 全屏状态变化：退出全屏');
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = '全屏';
            videoContainer.style.cursor = 'default';
        } else {
            console.log('🔄 全屏状态变化：进入全屏');
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = '退出全屏';
        }
    });

    document.addEventListener('webkitfullscreenchange', function() {
        if (!document.webkitFullscreenElement) {
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = '全屏';
            videoContainer.style.cursor = 'default';
        } else {
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = '退出全屏';
        }
    });

    document.addEventListener('mozfullscreenchange', function() {
        if (!document.mozFullScreenElement) {
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = '全屏';
            videoContainer.style.cursor = 'default';
        } else {
            isFullscreen = true;
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = '退出全屏';
        }
    });

    // 播放器事件
    player.addEventListener('loadedmetadata', function() {
        updateTimeDisplay();
        loadingIndicator.style.display = 'none';
    });

    player.addEventListener('play', function() {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        playPauseBtn.title = '暂停';
        
        // 开始更新进度条
        progressUpdateInterval = setInterval(updateProgress, 100);
        
        // 移除暂停状态
        videoContainer.classList.remove('paused');
        
        // 播放时短暂显示控制栏后隐藏
        showControls();
        setTimeout(() => {
            hideControls();
        }, 3000);
    });

    player.addEventListener('pause', function() {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.title = '播放';
        
        // 停止更新进度条
        clearInterval(progressUpdateInterval);
        
        // 暂停时始终显示控制栏
        videoContainer.classList.add('paused');
        showControls();
    });

    player.addEventListener('timeupdate', updateProgress);

    player.addEventListener('waiting', function() {
        loadingIndicator.style.display = 'block';
    });

    player.addEventListener('canplay', function() {
        loadingIndicator.style.display = 'none';
    });

    player.addEventListener('ended', function() {
        playPauseBtn.innerHTML = '<i class="fas fa-redo"></i>';
        playPauseBtn.title = '重新播放';
        clearInterval(progressUpdateInterval);
        
        // 播放结束时显示控制栏
        videoContainer.classList.add('paused');
        showControls();
    });
    
    // 进度条交互
    progressBar.addEventListener('click', updateProgressFromMouse);
    
    // 进度条拖拽
    progressBar.addEventListener('mousedown', function(e) {
        isDragging = true;
        updateProgressFromMouse(e);
        showControls();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (isDragging) {
            updateProgressFromMouse(e);
        }
    });
    
    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    // 控制栏事件
    playPauseBtn.addEventListener('click', function() {
        if (isTogglingPlayPause) return;
        
        isTogglingPlayPause = true;
        
        if (player.paused) {
            player.play().then(() => {
                isTogglingPlayPause = false;
            }).catch(error => {
                console.error('播放失败:', error);
                alert('视频播放失败，请检查视频文件');
                isTogglingPlayPause = false;
            });
        } else {
            player.pause();
            isTogglingPlayPause = false;
        }
    });

    // 清晰度选择器手动控制
    qualityBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('🎛️ [前端DEBUG] 点击清晰度按钮');
        
        const isOpen = qualityMenu.classList.contains('show');
        
        // 关闭所有其他下拉菜单
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
        
        // 切换当前菜单
        if (!isOpen) {
            qualityMenu.classList.add('show');
            console.log('✅ [前端DEBUG] 清晰度菜单已打开');
        } else {
            qualityMenu.classList.remove('show');
            console.log('❌ [前端DEBUG] 清晰度菜单已关闭');
        }
        
        showControls();
    });

    // 清晰度选项点击事件
    qualityMenu.addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
            e.preventDefault();
            e.stopPropagation();
            
            const quality = e.target.dataset.quality;
            console.log('🎬 [前端DEBUG] 选择清晰度:', quality);
            
            // 更新当前显示
            currentQualitySpan.textContent = quality;
            
            // 更新选中状态
            qualityMenu.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            e.target.classList.add('active');
            
            // 关闭菜单
            qualityMenu.classList.remove('show');
            
            // 实际进行分辨率切换
            console.log('🔄 [前端DEBUG] 开始切换分辨率:', quality);
            switchVideoResolution(quality);
            
            showControls();
        }
    });

    // 播放速度选择器手动控制
    speedBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('⚡ 点击播放速度按钮');
        
        const isOpen = speedMenu.classList.contains('show');
        
        // 关闭所有其他下拉菜单
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
        
        // 切换当前菜单
        if (!isOpen) {
            speedMenu.classList.add('show');
            console.log('✅ 播放速度菜单已打开');
        } else {
            speedMenu.classList.remove('show');
            console.log('❌ 播放速度菜单已关闭');
        }
        
        showControls();
    });

    // 播放速度选项点击事件
    speedMenu.addEventListener('click', function(e) {
        if (e.target.classList.contains('dropdown-item')) {
            e.preventDefault();
            e.stopPropagation();
            
            const speed = parseFloat(e.target.dataset.speed);
            console.log('⚡ 选择播放速度:', speed);
            
            // 更新播放速度
            if (player) {
                player.playbackRate = speed;
                currentSpeedSpan.textContent = speed + 'x';
                console.log('✅ 播放速度已设置为:', speed);
            }
            
            // 更新选中状态
            speedMenu.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            e.target.classList.add('active');
            
            // 关闭菜单
            speedMenu.classList.remove('show');
            
            showControls();
        }
    });

    // 点击其他地方关闭下拉菜单
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.quality-selector') && !e.target.closest('.playback-speed')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // 快退按钮事件
    rewindBtn.addEventListener('click', function() {
        if (player.currentTime > 0) {
            player.currentTime = Math.max(0, player.currentTime - 10);
        }
    });

    // 快进按钮事件
    forwardBtn.addEventListener('click', function() {
        if (player.duration) {
            player.currentTime = Math.min(player.duration, player.currentTime + 10);
        }
    });

    // 静音按钮事件
    muteBtn.addEventListener('click', function() {
        player.muted = !player.muted;
        
        if (player.muted) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            muteBtn.title = '取消静音';
        } else {
            updateMuteButton();
        }
    });

    // 音量滑块事件
    volumeSlider.addEventListener('input', function() {
        player.volume = this.value;
        player.muted = (this.value === 0);
        updateMuteButton();
    });

    // 全屏按钮事件
    fullscreenBtn.addEventListener('click', toggleFullscreen);

    // 画中画按钮事件
    pipBtn.addEventListener('click', function() {
        // 检查浏览器是否支持画中画
        if (document.pictureInPictureElement) {
            document.exitPictureInPicture()
                .then(() => {
                    pipBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                    pipBtn.title = '画中画';
                })
                .catch(error => {
                    console.error('退出画中画失败:', error);
                });
        } else if (document.pictureInPictureEnabled) {
            player.requestPictureInPicture()
                .then(() => {
                    pipBtn.innerHTML = '<i class="fas fa-compress-alt"></i>';
                    pipBtn.title = '退出画中画';
                })
                .catch(error => {
                    console.error('进入画中画失败:', error);
                });
        } else {
            alert('您的浏览器不支持画中画功能');
        }
    });

    // 播放速度选择事件
    speedItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const speed = parseFloat(this.getAttribute('data-speed'));
            player.playbackRate = speed;
            
            // 更新当前速度显示
            currentSpeedSpan.textContent = `${speed}x`;
            
            // 更新选中状态
            speedItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // 分辨率选择点击事件 - 实时转码版本
    function initializeQualitySelection() {
        const qualityItems = qualityMenu.querySelectorAll('.dropdown-item');
        
        qualityItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const quality = this.getAttribute('data-quality');
                console.log('🎯 [实时转码] 用户选择分辨率:', quality);
                
                if (quality === currentQuality) {
                    console.log('⚠️ [实时转码] 相同分辨率，跳过切换');
                    qualityMenu.classList.remove('show');
                    return;
                }
                
                // 更新界面显示
                qualityItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                currentQualitySpan.textContent = quality;
                currentQuality = quality;
                
                // 关闭菜单
                qualityMenu.classList.remove('show');
                
                // 实际进行分辨率切换 - 使用实时转码
                console.log('🚀 [实时转码] 开始切换到:', quality);
                switchVideoResolution(quality);
                
                showControls();
            });
        });
        
        console.log('✅ [实时转码] 分辨率选择器已初始化，支持分辨率:', 
            Array.from(qualityItems).map(item => item.getAttribute('data-quality')));
    }
    
    // 动态加载可用分辨率
    function loadAvailableResolutions() {
        console.log('🔍 [实时转码] 正在获取可用分辨率...');
        
        fetch(`/api/{{ movie.pk }}/resolutions/`)
            .then(response => response.json())
            .then(data => {
                console.log('📊 [实时转码] API响应:', data);
                
                if (data.success && data.resolutions) {
                    const resolutions = data.resolutions;
                    console.log('✅ [实时转码] 可用分辨率:', resolutions);
                    
                    // 清空现有选项
                    qualityMenu.innerHTML = '';
                    
                    // 添加分辨率选项
                    resolutions.forEach((resolution, index) => {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item';
                        item.href = '#';
                        item.setAttribute('data-quality', resolution);
                        item.textContent = resolution;
                        
                        // 第一个选项（原画）设为活动状态
                        if (index === 0) {
                            item.classList.add('active');
                        }
                        
                        qualityMenu.appendChild(item);
                    });
                    
                    // 重新初始化点击事件
                    initializeQualitySelection();
                    
                    console.log('🎯 [实时转码] 分辨率菜单已更新');
                } else {
                    console.error('❌ [实时转码] 获取分辨率失败:', data.error);
                    // 使用默认分辨率
                    qualityMenu.innerHTML = `
                        <a class="dropdown-item active" data-quality="原画" href="#">原画</a>
                        <a class="dropdown-item" data-quality="720p" href="#">720p</a>
                        <a class="dropdown-item" data-quality="480p" href="#">480p</a>
                        <a class="dropdown-item" data-quality="360p" href="#">360p</a>
                    `;
                    initializeQualitySelection();
                }
            })
            .catch(error => {
                console.error('❌ [实时转码] 网络错误:', error);
                // 使用默认分辨率
                qualityMenu.innerHTML = `
                    <a class="dropdown-item active" data-quality="原画" href="#">原画</a>
                    <a class="dropdown-item" data-quality="720p" href="#">720p</a>
                    <a class="dropdown-item" data-quality="480p" href="#">480p</a>
                    <a class="dropdown-item" data-quality="360p" href="#">360p</a>
                `;
                initializeQualitySelection();
            });
    }
    
    // 加载可用分辨率
    loadAvailableResolutions();

    // 旧的预转码代码已清理，使用实时转码

    // 初始化
    initializePlayerState();
    showControls();
    
    // 尝试加载可用分辨率
    loadAvailableResolutions();
});
</script>
{% endblock %} 